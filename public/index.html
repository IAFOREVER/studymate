<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />

    <title>StudyMate Agenda - Móvil</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
      /* [GLOBAL] :: UI - Estilos generales y para componentes específicos. */
      .layout-content-container {
        width: 100%;
      }
      @media (max-width: 768px) {
        .layout-content-container {
          max-width: 100%;
        }
      }
      button:hover div,
      a:hover {
        opacity: 0.8;
        transition: opacity 0.2s ease-in-out;
      }
      button:active div,
      a:active {
        opacity: 0.6;
      }
      .selected-day-bg {
        background-color: #6a8eeb;
      }
      .day-name-header {
        text-transform: uppercase;
        font-size: 0.8rem;
        background-color: #f0f4f8;
      }
      #datePickerCalendar .day-cell,
      #datePickerCalendarAssignment .day-cell,
      #datePickerCalendarExam .day-cell,
      #datePickerCalendarEvent .day-cell {
        height: 2.25rem;
        width: 2.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        font-weight: 500;
        transition: background-color 0.15s ease-in-out,
          color 0.15s ease-in-out;
      }
      #datePickerCalendar .day-cell.hover\:bg-blue-100:hover,
      #datePickerCalendarAssignment .day-cell.hover\:bg-blue-100:hover,
      #datePickerCalendarExam .day-cell.hover\:bg-blue-100:hover,
      #datePickerCalendarEvent .day-cell.hover\:bg-blue-100:hover {
        background-color: #dbeafe;
      }
      #datePickerCalendar .day-cell.bg-blue-500,
      #datePickerCalendarAssignment .day-cell.bg-blue-500,
      #datePickerCalendarExam .day-cell.bg-blue-500,
      #datePickerCalendarEvent .day-cell.bg-blue-500 {
        background-color: #3b82f6;
        color: white;
      }
      #datePickerCalendar .day-cell.border,
      #datePickerCalendarAssignment .day-cell.border,
      #datePickerCalendarExam .day-cell.border,
      #datePickerCalendarEvent .day-cell.border {
        border-width: 1px;
      }
      #datePickerCalendar .day-cell.border-blue-500,
      #datePickerCalendarAssignment .day-cell.border-blue-500,
      #datePickerCalendarExam .day-cell.border-blue-500,
      #datePickerCalendarEvent .day-cell.border-blue-500 {
        border-color: #3b82f6;
      }

      /* [TASKS & ASSIGNMENTS] :: UI :: PriorityButtons - Estilos para la versión final de los botones de prioridad.*/
      .priority-group {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 1rem;
        align-items: center;
        min-height: 40px;
      }
      .priority-controls {
          display: flex;
          align-items: center;
          gap: 1rem;
      }
      .priority-buttons-container {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      .priority-output {
        font-weight: 600;
        color: #312e81; /* Premium Indigo color */
        text-shadow: 0px 1px 1px rgba(0,0,0,0.05);
        transition: opacity 0.3s ease;
      }
      .priority-btn {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #f9fafb;
        border: 2px solid #d1d5db;
        transition: all 0.1s ease-in-out;
        cursor: pointer;
        position: relative;
        padding: 2px;
        box-sizing: content-box;
      }
       .priority-btn:hover {
         border-color: #9ca3af;
       }
      .priority-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0;
        height: 0;
        border-radius: 50%;
        transition: all 0.1s ease-in-out;
      }
      .priority-btn.active {
        border-width: 2px;
      }
      .priority-btn.active::after {
        width: 10px;
        height: 10px;
      }
      .priority-btn.active.low { border-color: #22c55e; }
      .priority-btn.active.low::after { background-color: #22c55e; }
      .priority-btn.active.medium { border-color: #f59e0b; }
      .priority-btn.active.medium::after { background-color: #f59e0b; }
      .priority-btn.active.high { border-color: #ef4444; }
      .priority-btn.active.high::after { background-color: #ef4444; }

      /* [TASKS & ASSIGNMENTS] :: UI :: Card - Estilos para las tarjetas, incluyendo el indicador de prioridad y estado completado. */
      .task-card, .assignment-card, .exam-card {
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, opacity 0.3s ease-in-out;
      }
      .task-card:hover, .assignment-card:hover, .exam-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      }
      .task-card.completed, .assignment-card.completed, .exam-card.completed {
        opacity: 0.6;
      }
      .priority-indicator {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
      }
      .priority-low { background-color: #22c55e; }
      .priority-medium { background-color: #f59e0b; }
      .priority-high { background-color: #ef4444; }
      
      /* [TASKS & ASSIGNMENTS] :: UI :: Checkbox - Estilos para el checkbox de completado en la tarjeta. */
      input[type="checkbox"].completion-checkbox {
        height: 14px;
        width: 14px;
        border-width: 2px;
      }
      .completed-text {
        font-size: 0.75rem; /* 12px */
        font-style: italic;
        color: #475569; /* slate-600 */
        opacity: 0.9;
      }

      /* [TASKS & ASSIGNMENTS] :: UI :: SortControl - Estilos para el control de ordenamiento. */
      .sort-dropdown {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 0.5rem;
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        z-index: 20;
        overflow: hidden;
      }
      .sort-option {
        padding: 0.5rem 1rem;
        cursor: pointer;
      }
      .sort-option:hover {
        background-color: #f3f4f6;
      }
      #sort-direction-icon, #assignment-sort-direction-icon, #exam-sort-direction-icon {
        transition: transform 0.2s ease-in-out;
      }
      #toggle-completed-btn, #assignment-toggle-completed-btn, #exam-toggle-completed-btn {
        transition: transform 0.1s ease-in-out;
      }
      #toggle-completed-btn:active, #assignment-toggle-completed-btn:active, #exam-toggle-completed-btn:active {
        transform: scale(0.9);
      }
      
      /* [SETTINGS] :: UI :: Avatar - Estilos para la selección de avatar */
      #current-avatar-img {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }
      #current-avatar-img:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(106, 142, 235, 0.5);
      }
      .avatar-option img {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .avatar-option:hover img {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
    </style>

</head>
  <body>
    <div
      class="relative flex size-full min-h-screen flex-col bg-slate-50 group/design-root overflow-x-hidden"
      style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif'
    >
      <div class="layout-container flex h-full grow flex-col">
        <header
          class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#e7edf3] px-4 py-3 sm:px-10"
        >
          <div class="flex items-center gap-2 sm:gap-4 text-[#334155]">
            <div class="size-6">
              <svg
                viewBox="0 0 48 48"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z"
                  fill="currentColor"
                ></path>
              </svg>
            </div>
            <h2
              class="text-[#334155] text-xl font-bold leading-tight tracking-[-0.015em] block"
            >
              StudyMate
            </h2>
          </div>
          <div class="flex items-center gap-x-3 ml-auto pl-4">
            <div
              id="userIconContainer"
              class="hidden sm:block size-8 mr-2 cursor-pointer"
            ></div>
            <nav class="items-center gap-4 sm:gap-9 hidden sm:flex header-links">
              <a
                class="text-[#334155] text-sm font-medium leading-normal cursor-pointer hover:text-[#6A8EEB]"
                data-section="panel"
                >Panel</a
              >
              <a
                class="text-[#334155] text-sm font-medium leading-normal cursor-pointer hover:text-[#6A8EEB]"
                data-section="calendar"
                >Calendario</a
              >
              <a
                class="text-[#334155] text-sm font-medium leading-normal cursor-pointer hover:text-[#6A8EEB]"
                data-section="tasks"
                >Tareas</a
              >
              <a
                class="text-[#334155] text-sm font-medium leading-normal cursor-pointer hover:text-[#6A8EEB]"
                data-section="assignments"
                >Trabajos Prácticos</a
              >
              <a
                class="text-[#334155] text-sm font-medium leading-normal cursor-pointer hover:text-[#6A8EEB]"
                data-section="exams"
                >Exámenes</a
              >
              <a
                class="text-[#334155] text-sm font-medium leading-normal cursor-pointer hover:text-[#6A8EEB]"
                data-section="events"
                >Eventos</a
              >
            </nav>
            <div
              id="userIconContainerMobile"
              class="block sm:hidden size-8 mx-auto cursor-pointer"
            ></div>
            <button
              id="hamburgerBtn"
              class="sm:hidden flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 bg-[#e7edf3] text-[#334155] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5 shadow-sm hover:shadow-md transition-shadow"
            >
              <div
                class="text-[#334155]"
                data-icon="Menu"
                data-size="20px"
                data-weight="regular"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20px"
                  height="20px"
                  fill="currentColor"
                  viewBox="0 0 256 256"
                >
                  <path
                    d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM40,72H216a8,8,0,0,0,0-16H40a8,8,0,0,0,0,16ZM216,184H40a8,8,0,0,0,0,16H216a8,8,0,0,0,0-16Z"
                  ></path>
                </svg>
              </div>
            </button>
            <button
              id="bellBtn"
              title="Notificaciones"
              class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-10 bg-[#e7edf3] text-[#334155] gap-2 text-sm font-bold leading-normal tracking-[0.015em] min-w-0 px-2.5 shadow-sm hover:shadow-md transition-shadow"
            >
              <div
                class="text-[#334155]"
                data-icon="Bell"
                data-size="20px"
                data-weight="regular"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20px"
                  height="20px"
                  fill="currentColor"
                  viewBox="0 0 256 256"
                >
                  <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                  ></path>
                </svg>
              </div>
            </button>
          </div>
        </header>

        <div
          id="mobile-menu"
          class="hidden fixed top-0 left-0 w-full h-full bg-white z-40 overflow-y-auto p-6"
        >
          <div class="flex justify-end mb-8">
            <button
              id="closeMobileMenuBtn"
              class="text-[#334155] p-2 rounded-full hover:bg-gray-100"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24px"
                height="24px"
                fill="currentColor"
                viewBox="0 0 256 256"
              >
                <path
                  d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31l-66.34,66.35a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66a8,8,0,0,1,11.32-11.32L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"
                ></path>
              </svg>
            </button>
          </div>
          <nav
            class="flex flex-col gap-6 text-xl font-semibold text-gray-800"
          >
            <a class="hover:text-[#6A8EEB] cursor-pointer" data-section="panel"
              >Panel</a
            >
            <a
              class="hover:text-[#6A8EEB] cursor-pointer"
              data-section="calendar"
              >Calendario</a
            >
            <a class="hover:text-[#6A8EEB] cursor-pointer" data-section="tasks"
              >Tareas</a
            >
            <a
              class="hover:text-[#6A8EEB] cursor-pointer"
              data-section="assignments"
              >Trabajos Prácticos</a
            >
            <a class="hover:text-[#6A8EEB] cursor-pointer" data-section="exams"
              >Exámenes</a
            >
            <a class="hover:text-[#6A8EEB] cursor-pointer" data-section="events"
              >Eventos</a
            >
          </nav>
        </div>

        <div class="flex flex-1 justify-center py-5 px-2 sm:px-10 md:px-40">
          <div
            id="panel-section"
            class="layout-content-container w-full flex-col max-w-[960px] flex-1 hidden bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <h2
              class="text-[#334155] text-3xl font-bold leading-tight tracking-[-0.015em] mb-4"
            >
              Panel de Control
            </h2>
            <p
              id="welcomeMessage"
              class="text-[#4e7497] text-base font-normal leading-normal mb-6"
            >
              Bienvenido a tu panel. Inicia sesión para ver y gestionar tus eventos.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-blue-100 rounded-lg p-4 shadow-md">
                <h3 class="text-blue-800 text-lg font-bold mb-2">
                  Tareas Pendientes
                </h3>
                <p class="text-blue-700">Tienes 3 tareas para esta semana.</p>
              </div>
              <div class="bg-purple-100 rounded-lg p-4 shadow-md">
                <h3 class="text-purple-800 text-lg font-bold mb-2">
                  Próximos Exámenes
                </h3>
                <p class="text-purple-700">
                  Un examen de Matemáticas el 20 de Octubre.
                </p>
              </div>
            </div>
            <h2
              class="text-[#334155] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5"
            >
              Próximos Eventos
            </h2>
            <div id="upcomingEvents" class="flex flex-col gap-2 p-2 mb-6"></div>
          </div>

          <div
            id="calendar-section"
            class="layout-content-container w-full flex flex-col max-w-[960px] flex-1 bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <div class="flex flex-wrap justify-between gap-3 p-4">
              <div class="flex min-w-72 flex-col gap-3">
                <p
                  class="text-[#334155] tracking-light text-[32px] font-bold leading-tight"
                >
                  Calendario
                </p>
                <p class="text-[#4e7497] text-sm font-normal leading-normal">
                  Organiza tu tiempo y no te pierdas nada.
                </p>
              </div>
            </div>

            <div class="flex justify-center gap-2 mb-4">
              <button
                class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#6A8EEB] text-white shadow-md hover:opacity-90 transition-opacity"
                data-calendar-view="month"
              >
                Mes
              </button>
              <button
                class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#e7edf3] text-[#334155] shadow-sm hover:bg-[#d1e2f3] transition-colors"
                data-calendar-view="week"
              >
                Semana
              </button>
              <button
                class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#e7edf3] text-[#334155] shadow-sm hover:bg-[#d1e2f3] transition-colors"
                data-calendar-view="day"
              >
                Día
              </button>
            </div>

            <div
              id="month-view"
              class="flex flex-wrap items-center justify-center gap-6 p-4"
            >
              <div class="flex min-w-72 max-w-[336px] flex-1 flex-col gap-0.5">
                <div class="flex items-center p-1 justify-between">
                  <button id="prevMonthBtn" class="hover:bg-slate-100 rounded-full">
                    <div
                      class="text-[#334155] flex size-10 items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18px"
                        height="18px"
                        fill="currentColor"
                        viewBox="0 0 256 256"
                      >
                        <path
                          d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"
                        ></path>
                      </svg>
                    </div>
                  </button>
                  <p
                    id="monthDisplay"
                    class="text-[#334155] text-base font-bold leading-tight flex-1 text-center"
                  ></p>
                  <button id="nextMonthBtn" class="hover:bg-slate-100 rounded-full">
                    <div
                      class="text-[#334155] flex size-10 items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18px"
                        height="18px"
                        fill="currentColor"
                        viewBox="0 0 256 256"
                      >
                        <path
                          d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"
                        ></path>
                      </svg>
                    </div>
                  </button>
                </div>
                <div
                  class="grid grid-cols-7 w-full border-t border-r border-l border-slate-200 rounded-t-lg overflow-hidden"
                >
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Lu</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Ma</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Mi</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Ju</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Vi</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Sa</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r-0"
                  >Do</p>
                </div>
                <div
                  id="calendarDaysMonth"
                  class="grid grid-cols-7 w-full border-b border-l border-r border-slate-200 rounded-b-lg overflow-hidden -mt-px"
                ></div>
              </div>
            </div>

            <div
              id="week-view"
              class="hidden flex-wrap items-center justify-center gap-6 p-4"
            >
              <div
                class="flex min-w-72 max-w-[960px] flex-1 flex-col gap-0.5"
              >
                <div class="flex items-center p-1 justify-between">
                  <button id="prevWeekBtn" class="hover:bg-slate-100 rounded-full">
                    <div
                      class="text-[#334155] flex size-10 items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18px"
                        height="18px"
                        fill="currentColor"
                        viewBox="0 0 256 256"
                      >
                        <path
                          d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"
                        ></path>
                      </svg>
                    </div>
                  </button>
                  <p
                    id="weekDisplay"
                    class="text-[#334155] text-base font-bold leading-tight flex-1 text-center"
                  ></p>
                  <button id="nextWeekBtn" class="hover:bg-slate-100 rounded-full">
                    <div
                      class="text-[#334155] flex size-10 items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18px"
                        height="18px"
                        fill="currentColor"
                        viewBox="0 0 256 256"
                      >
                        <path
                          d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"
                        ></path>
                      </svg>
                    </div>
                  </button>
                </div>
                <div
                  class="grid grid-cols-7 w-full border-t border-r border-l border-slate-200 rounded-t-lg overflow-hidden"
                >
                   <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Lu</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Ma</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Mi</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Ju</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Vi</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  >Sa</p>
                  <p
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r-0"
                  >Do</p>
                </div>
                <div
                  id="calendarDaysWeek"
                  class="grid grid-cols-7 w-full border-b border-l border-r border-slate-200 rounded-b-lg overflow-hidden -mt-px"
                ></div>
              </div>
            </div>

            <div
              id="day-view"
              class="hidden flex-wrap items-center justify-center gap-6 p-4"
            >
              <div
                class="flex min-w-72 max-w-[960px] flex-1 flex-col gap-0.5"
              >
                <div class="flex items-center p-1 justify-between">
                  <button id="prevDayBtn" class="hover:bg-slate-100 rounded-full">
                    <div
                      class="text-[#334155] flex size-10 items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18px"
                        height="18px"
                        fill="currentColor"
                        viewBox="0 0 256 256"
                      >
                        <path
                          d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"
                        ></path>
                      </svg>
                    </div>
                  </button>
                  <p
                    id="dayDisplay"
                    class="text-[#334155] text-base font-bold leading-tight flex-1 text-center"
                  ></p>
                  <button id="nextDayBtn" class="hover:bg-slate-100 rounded-full">
                    <div
                      class="text-[#334155] flex size-10 items-center justify-center"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18px"
                        height="18px"
                        fill="currentColor"
                        viewBox="0 0 256 256"
                      >
                        <path
                          d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"
                        ></path>
                      </svg>
                    </div>
                  </button>
                </div>
                <div
                  class="grid grid-cols-1 w-full border-t border-r border-l border-slate-200 rounded-t-lg overflow-hidden"
                >
                  <p
                    id="currentDayNameDisplay"
                    class="text-[#4e7497] day-name-header flex h-10 w-full items-center justify-center border-b border-r border-slate-200 last:border-r-0"
                  ></p>
                </div>
                <div
                  id="calendarDaysDay"
                  class="grid grid-cols-1 w-full border-b border-l border-r border-slate-200 rounded-b-lg overflow-hidden -mt-px"
                ></div>
              </div>
            </div>

            <h2
              id="selectedDayTitle"
              class="text-[#334155] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5"
            ></h2>
            <div
              id="selectedDayEventsContainer"
              class="flex flex-col gap-2 p-2"
            ></div>

            <h2
              id="monthEventsTitle"
              class="text-[#334155] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5"
            >
              Eventos del Mes
            </h2>
            <div
              id="monthEventsContainer"
              class="flex flex-col gap-2 p-2"
            ></div>

            <h2
              id="weekEventsTitle"
              class="text-[#334155] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5 hidden"
            >
              Eventos de la Semana
            </h2>
            <div
              id="weekEventsContainer"
              class="flex flex-col gap-2 p-2 hidden"
            ></div>
          </div>

          <div
            id="tasks-section"
            class="layout-content-container w-full flex-col max-w-[960px] flex-1 hidden bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <h2
              class="text-[#334155] text-3xl font-bold leading-tight tracking-[-0.015em] mb-4"
            >
              Mis Tareas
            </h2>
            <p
              class="text-[#4e7497] text-base font-normal leading-normal mb-6"
            >
              Aquí puedes gestionar tus tareas pendientes. ¡Vamos a
              completarlas!
            </p>
            <button
              id="showAddTaskModalBtn"
              class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#A3D9E9] text-[#334155] shadow-md hover:bg-[#8CD0E4] transition-colors"
            >
              Añadir Nueva Tarea
            </button>

            <div id="successMessage" class="mt-4 mx-auto p-3 hidden w-fit">
              <div
                class="bg-green-100 text-green-800 px-6 py-3 rounded-full shadow-lg flex items-center space-x-2"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"></path></svg>
                <span></span>
              </div>
            </div>

            <div
              id="addTaskFormContainer"
              class="mt-6 p-4 border border-gray-200 rounded-xl bg-gray-50 hidden"
            >
              <h3 class="text-xl font-bold text-[#334155] mb-4"></h3>
              <form id="taskForm" class="space-y-4">
                <div class="relative">
                  <label
                    for="taskDate"
                    class="block text-sm font-medium text-[#334155]"
                    >Fecha:</label
                  >
                  <input
                    type="text"
                    id="taskDate"
                    readonly
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2 cursor-pointer"
                  />
                  <div
                    id="datePickerCalendar"
                    class="absolute bg-white border border-gray-300 rounded-lg shadow-lg z-10 p-2 mt-1 hidden"
                  >
                    <div class="flex items-center justify-between mb-2">
                      <button
                        type="button"
                        id="prevDatePickerMonth"
                        class="text-[#334155] p-1 rounded-full hover:bg-gray-100"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18px"
                          height="18px"
                          fill="currentColor"
                          viewBox="0 0 256 256"
                        >
                          <path
                            d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"
                          ></path>
                        </svg>
                      </button>
                      <span
                        id="datePickerMonthDisplay"
                        class="font-bold text-[#334155]"
                      ></span>
                      <button
                        type="button"
                        id="nextDatePickerMonth"
                        class="text-[#334155] p-1 rounded-full hover:bg-gray-100"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18px"
                          height="18px"
                          fill="currentColor"
                          viewBox="0 0 256 256"
                        >
                          <path
                            d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"
                          ></path>
                        </svg>
                      </button>
                    </div>
                    <div
                      class="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 mb-1"
                    >
                      <span>Lu</span><span>Ma</span><span>Mi</span
                      ><span>Ju</span><span>Vi</span><span>Sa</span
                      ><span>Do</span>
                    </div>
                    <div
                      id="datePickerDays"
                      class="grid grid-cols-7 gap-0.5 text-sm"
                    ></div>
                  </div>
                </div>
                <div>
                  <label for="taskSubjectSelect" class="block text-sm font-medium text-[#334155]">Materia:</label>
                  <select id="taskSubjectSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2">
                    <!-- Las opciones se cargarán dinámicamente -->
                  </select>
                </div>
                <div>
                  <label
                    for="taskDescription"
                    class="block text-sm font-medium text-[#334155]"
                    >Descripción de la Tarea:</label
                  >
                  <textarea
                    id="taskDescription"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2"
                  ></textarea>
                </div>
                <div class="flex space-x-4">
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="taskTypeIndividual"
                      value="Individual"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Individual</span>
                  </label>
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="taskTypeGroup"
                      value="Grupal"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Grupal</span>
                  </label>
                </div>
                
                <div class="priority-group">
                    <label class="text-sm font-medium text-[#334155]">Prioridad:</label>
                    <div class="priority-controls" id="priority-container">
                      <div class="priority-buttons-container" id="priority-group-final">
                          <button type="button" data-priority="low" class="priority-btn"></button>
                          <button type="button" data-priority="medium" class="priority-btn"></button>
                          <button type="button" data-priority="high" class="priority-btn"></button>
                      </div>
                      <span id="priority-output" class="priority-output opacity-0 min-w-[5ch]"></span>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row sm:justify-end gap-3 pt-4">
                  <button
                    type="button"
                    id="cancelAddTask"
                    class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    id="saveTask"
                    class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-semibold bg-[#6A8EEB] text-white hover:bg-[#5a7ddc] transition-colors whitespace-nowrap"
                  ></button>
                </div>
              </form>
            </div>

            <div class="mt-4 border-t border-slate-200 pt-4">
              <div class="flex justify-between items-center mb-2 px-2">
                  <p class="text-[#4e7497] italic">Lista de tareas...</p>
                  <div class="relative flex items-center gap-2">
                      <button id="sort-criteria-btn" class="flex items-center gap-1 text-sm font-semibold text-gray-600 hover:text-gray-900">
                          <span id="sort-criteria-text">Prioridad</span>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,48,88H208a8,8,0,0,1,5.66,13.66Z"></path></svg>
                      </button>
                      <div id="sort-dropdown" class="sort-dropdown hidden">
                          <div class="sort-option" data-sort="priority">Prioridad</div>
                          <div class="sort-option" data-sort="date">Fecha</div>
                      </div>
                      <button id="sort-direction-btn" class="p-1 rounded-full hover:bg-gray-200">
                          <svg id="sort-direction-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24a8,8,0,0,0-8,8V203.51l-29.66-29.65a8,8,0,0,0-11.32,11.31l44.69,44.69a8,8,0,0,0,11.32,0l44.69-44.69a8,8,0,0,0-11.32-11.31L136,203.51V32A8,8,0,0,0,128,24Z"></path></svg>
                      </button>
                      <button id="toggle-completed-btn" class="p-1 rounded-full hover:bg-gray-200">
                          <svg id="eye-open-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3" fill="#3b82f6"></circle></svg>
                          <svg id="eye-closed-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3" fill="#3b82f6"></circle><path d="m2 2 20 20"></path></svg>
                      </button>
                  </div>
              </div>
              <div
                id="tasksListContainer"
                class="flex flex-col gap-2 p-2"
              ></div>
            </div>
          </div>

          <div
            id="assignments-section"
            class="layout-content-container flex-col max-w-[960px] flex-1 hidden bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <h2
              class="text-[#334155] text-3xl font-bold leading-tight tracking-[-0.015em] mb-4"
            >
              Mis Trabajos Prácticos
            </h2>
            <p
              class="text-[#4e7497] text-base font-normal leading-normal mb-6"
            >
              Gestiona tus trabajos prácticos y fechas de entrega.
            </p>
            <button
              id="showAddAssignmentModalBtn"
              class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#C3E6CB] text-[#334155] shadow-md hover:bg-[#ADD6B9] transition-colors"
            >
              Añadir Nuevo Trabajo Práctico
            </button>

            <div
              id="assignmentSuccessMessage"
              class="mt-4 mx-auto p-3 hidden w-fit"
            >
              <div
                class="bg-green-100 text-green-800 px-6 py-3 rounded-full shadow-lg flex items-center space-x-2"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm45.66,85.66-56,56a8,8,0,0,1-11.32,0l-24-24a8,8,0,0,1,11.32-11.32L112,148.69l50.34-50.35a8,8,0,0,1,11.32,11.32Z"></path>
                </svg>
                <span>¡Trabajo Práctico guardado con éxito!</span>
              </div>
            </div>

            <div
              id="addAssignmentFormContainer"
              class="mt-6 p-4 border border-gray-200 rounded-xl bg-gray-50 hidden"
            >
              <h3 class="text-xl font-bold text-[#334155] mb-4"></h3>
              <form id="assignmentForm" class="space-y-4">
                <div class="relative">
                  <label
                    for="assignmentDate"
                    class="block text-sm font-medium text-[#334155]"
                    >Fecha de Entrega:</label
                  >
                  <input
                    type="text"
                    id="assignmentDate"
                    readonly
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2 cursor-pointer"
                  />
                  <div
                    id="datePickerCalendarAssignment"
                    class="absolute bg-white border border-gray-300 rounded-lg shadow-lg z-10 p-2 mt-1 hidden"
                  >
                    <div class="flex items-center justify-between mb-2">
                        <button type="button" id="prevDatePickerMonthAssignment" class="text-[#334155] p-1 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256"><path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path></svg>
                        </button>
                        <span id="datePickerMonthDisplayAssignment" class="font-bold text-[#334155]"></span>
                        <button type="button" id="nextDatePickerMonthAssignment" class="text-[#334155] p-1 rounded-full hover:bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 mb-1">
                        <span>Lu</span><span>Ma</span><span>Mi</span><span>Ju</span><span>Vi</span><span>Sa</span><span>Do</span>
                    </div>
                    <div id="datePickerDaysAssignment" class="grid grid-cols-7 gap-0.5 text-sm"></div>
                  </div>
                </div>
                    <div>
                      <label for="assignmentSubjectSelect" class="block text-sm font-medium text-[#334155]">Materia:</label>
                      <select id="assignmentSubjectSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2">
                        <!-- Las opciones se cargarán dinámicamente -->
                      </select>
                    </div>
                <div>
                  <label
                    for="assignmentDescription"
                    class="block text-sm font-medium text-[#334155]"
                    >Descripción del Trabajo Práctico:</label
                  >
                  <textarea
                    id="assignmentDescription"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2"
                  ></textarea>
                </div>
                <div class="flex space-x-4">
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="assignmentTypeIndividual"
                      value="Individual"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Individual</span>
                  </label>
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="assignmentTypeGroup"
                      value="Grupal"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Grupal</span>
                  </label>
                </div>
                   <div class="priority-group" id="assignment-priority-container">
                    <label class="text-sm font-medium text-[#334155]">Prioridad:</label>
                    <div class="priority-controls">
                        <div class="priority-buttons-container" id="assignment-priority-group-final">
                            <button type="button" data-priority="low" class="priority-btn"></button>
                            <button type="button" data-priority="medium" class="priority-btn"></button>
                            <button type="button" data-priority="high" class="priority-btn"></button>
                        </div>
                        <span id="assignment-priority-output" class="priority-output opacity-0 min-w-[5ch]"></span>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row sm:justify-end gap-3 pt-4">
                  <button
                    type="button"
                    id="cancelAddAssignment"
                    class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    id="saveAssignment"
                    class="w-full sm:w-auto px-4 py-2 rounded-lg text-sm font-semibold bg-[#6A8EEB] text-white hover:bg-[#5a7ddc] transition-colors whitespace-nowrap"
                  >
                  </button>
                </div>
              </form>
            </div>

            <div class="mt-4 border-t border-slate-200 pt-4">
               <div class="flex justify-between items-center mb-2 px-2">
                  <p class="text-[#4e7497] italic">Lista de Trabajos Prácticos...</p>
                  <div class="relative flex items-center gap-2">
                      <button id="assignment-sort-criteria-btn" class="flex items-center gap-1 text-sm font-semibold text-gray-600 hover:text-gray-900">
                          <span id="assignment-sort-criteria-text">Prioridad</span>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,48,88H208a8,8,0,0,1,5.66,13.66Z"></path></svg>
                      </button>
                      <div id="assignment-sort-dropdown" class="sort-dropdown hidden">
                          <div class="sort-option" data-sort="priority">Prioridad</div>
                          <div class="sort-option" data-sort="date">Fecha</div>
                      </div>
                      <button id="assignment-sort-direction-btn" class="p-1 rounded-full hover:bg-gray-200">
                          <svg id="assignment-sort-direction-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24a8,8,0,0,0-8,8V203.51l-29.66-29.65a8,8,0,0,0-11.32,11.31l44.69,44.69a8,8,0,0,0,11.32,0l44.69-44.69a8,8,0,0,0-11.32-11.31L136,203.51V32A8,8,0,0,0,128,24Z"></path></svg>
                      </button>
                      <button id="assignment-toggle-completed-btn" class="p-1 rounded-full hover:bg-gray-200">
                          <svg id="assignment-eye-open-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3" fill="#3b82f6"></circle></svg>
                          <svg id="assignment-eye-closed-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3" fill="#3b82f6"></circle><path d="m2 2 20 20"></path></svg>
                      </button>
                  </div>
              </div>
              <div
                id="assignmentsListContainer"
                class="flex flex-col gap-2 p-2"
              ></div>
            </div>
          </div>

          <div
            id="exams-section"
            class="layout-content-container flex-col max-w-[960px] flex-1 hidden bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <h2
              class="text-[#334155] text-3xl font-bold leading-tight tracking-[-0.015em] mb-4"
            >
              Próximos Exámenes
            </h2>
            <p
              class="text-[#4e7497] text-base font-normal leading-normal mb-6"
            >
              ¡Prepárate para tus exámenes con tiempo!
            </p>
            <button
              id="showAddExamModalBtn"
              class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#FFD7A3] text-[#334155] shadow-md hover:bg-[#FFC682] transition-colors"
            >
              Añadir Nuevo Examen
            </button>

            <div id="examSuccessMessage" class="mt-4 mx-auto p-3 hidden w-fit">
              <div
                class="bg-green-100 text-green-800 px-6 py-3 rounded-full shadow-lg flex items-center space-x-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="feather feather-check-circle"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-8.63"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span>¡Examen guardado con éxito!</span>
              </div>
            </div>

            <div
              id="addExamFormContainer"
              class="mt-6 p-4 border border-gray-200 rounded-xl bg-gray-50 hidden"
            >
              <h3 class="text-xl font-bold text-[#334155] mb-4">
                Añadir Nuevo Examen
              </h3>
              <form id="examForm" class="space-y-4">
                <div class="relative">
                  <label
                    for="examDate"
                    class="block text-sm font-medium text-[#334155]"
                    >Fecha:</label
                  >
                  <input
                    type="text"
                    id="examDate"
                    readonly
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2 cursor-pointer"
                  />
                  <div
                    id="datePickerCalendarExam"
                    class="absolute bg-white border border-gray-300 rounded-lg shadow-lg z-10 p-2 mt-1 hidden"
                  >
                    <div class="flex items-center justify-between mb-2">
                      <button
                        type="button"
                        id="prevDatePickerMonthExam"
                        class="text-[#334155] p-1 rounded-full hover:bg-gray-100"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18px"
                          height="18px"
                          fill="currentColor"
                          viewBox="0 0 256 256"
                        >
                          <path
                            d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"
                          ></path>
                        </svg>
                      </button>
                      <span
                        id="datePickerMonthDisplayExam"
                        class="font-bold text-[#334155]"
                      ></span>
                      <button
                        type="button"
                        id="nextDatePickerMonthExam"
                        class="text-[#334155] p-1 rounded-full hover:bg-gray-100"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18px"
                          height="18px"
                          fill="currentColor"
                          viewBox="0 0 256 256"
                        >
                          <path
                            d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"
                          ></path>
                        </svg>
                      </button>
                    </div>
                    <div
                      class="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 mb-1"
                    >
                      <span>Lu</span><span>Ma</span><span>Mi</span
                      ><span>Ju</span><span>Vi</span><span>Sa</span
                      ><span>Do</span>
                    </div>
                    <div
                      id="datePickerDaysExam"
                      class="grid grid-cols-7 gap-0.5 text-sm"
                    ></div>
                  </div>
                </div>
                <div>
                  <label
                    for="examTitle"
                    class="block text-sm font-medium text-[#334155]"
                    >Examen:</label
                  >
                  <input
                    type="text"
                    id="examTitle"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2"
                  />
                </div>
                <div>
                  <label
                    for="examDescription"
                    class="block text-sm font-medium text-[#334155]"
                    >Descripción (Opcional):</label
                  >
                  <textarea
                    id="examDescription"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2"
                  ></textarea>
                </div>
                <div class="flex space-x-4">
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="examTypeOral"
                      value="Oral"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Oral</span>
                  </label>
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="examTypeWritten"
                      value="Escrito"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Escrito</span>
                  </label>
                </div>
                <!-- Priority Group for Exams -->
                <div class="priority-group" id="exam-priority-container">
                    <label class="text-sm font-medium text-[#334155]">Prioridad:</label>
                    <div class="priority-controls">
                        <div class="priority-buttons-container" id="exam-priority-group-final">
                            <button type="button" data-priority="low" class="priority-btn"></button>
                            <button type="button" data-priority="medium" class="priority-btn"></button>
                            <button type="button" data-priority="high" class="priority-btn"></button>
                        </div>
                        <span id="exam-priority-output" class="priority-output opacity-0 min-w-[5ch]"></span>
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                  <button
                    type="button"
                    id="cancelAddExam"
                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    id="saveExam"
                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#6A8EEB] text-white hover:bg-[#5a7ddc] transition-colors"
                  >
                    Guardar Examen
                  </button>
                </div>
              </form>
            </div>

            <div class="mt-4 border-t border-slate-200 pt-4">
              <div class="flex justify-between items-center mb-2 px-2">
                  <p class="text-[#4e7497] italic">Lista de exámenes...</p>
                  <div class="relative flex items-center gap-2">
                      <button id="exam-sort-criteria-btn" class="flex items-center gap-1 text-sm font-semibold text-gray-600 hover:text-gray-900">
                          <span id="exam-sort-criteria-text">Prioridad</span>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,101.66l-80,80a8,8,0,0,1-11.32,0l-80-80A8,8,0,0,1,48,88H208a8,8,0,0,1,5.66,13.66Z"></path></svg>
                      </button>
                      <div id="exam-sort-dropdown" class="sort-dropdown hidden">
                          <div class="sort-option" data-sort="priority">Prioridad</div>
                          <div class="sort-option" data-sort="date">Fecha</div>
                      </div>
                      <button id="exam-sort-direction-btn" class="p-1 rounded-full hover:bg-gray-200">
                          <svg id="exam-sort-direction-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24a8,8,0,0,0-8,8V203.51l-29.66-29.65a8,8,0,0,0-11.32,11.31l44.69,44.69a8,8,0,0,0,11.32,0l44.69-44.69a8,8,0,0,0-11.32-11.31L136,203.51V32A8,8,0,0,0,128,24Z"></path></svg>
                      </button>
                      <button id="exam-toggle-completed-btn" class="p-1 rounded-full hover:bg-gray-200">
                          <svg id="exam-eye-open-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3" fill="#3b82f6"></circle></svg>
                          <svg id="exam-eye-closed-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3" fill="#3b82f6"></circle><path d="m2 2 20 20"></path></svg>
                      </button>
                  </div>
              </div>
              <div
                id="examsListContainer"
                class="flex flex-col gap-2 p-2"
              ></div>
            </div>
          </div>

          <div
            id="events-section"
            class="layout-content-container flex-col max-w-[960px] flex-1 hidden bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <h2
              class="text-[#334155] text-3xl font-bold leading-tight tracking-[-0.015em] mb-4"
            >
              Mis Eventos
            </h2>
            <p
              class="text-[#4e7497] text-base font-normal leading-normal mb-6"
            >
              Organiza tus eventos personales y académicos.
            </p>
            <button
              id="showAddEventModalBtn"
              class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#E0BBE4] text-[#334155] shadow-md hover:bg-[#D0A9D6] transition-colors"
            >
              Añadir Nuevo Evento
            </button>

            <div id="eventSuccessMessage" class="mt-4 mx-auto p-3 hidden w-fit">
              <div
                class="bg-green-100 text-green-800 px-6 py-3 rounded-full shadow-lg flex items-center space-x-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="feather feather-check-circle"
                >
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-8.63"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span>¡Evento guardado con éxito!</span>
              </div>
            </div>

            <div
              id="addEventFormContainer"
              class="mt-6 p-4 border border-gray-200 rounded-xl bg-gray-50 hidden"
            >
              <h3 class="text-xl font-bold text-[#334155] mb-4">
                Añadir Nuevo Evento
              </h3>
              <form id="eventForm" class="space-y-4">
                <div class="relative">
                  <label
                    for="eventDate"
                    class="block text-sm font-medium text-[#334155]"
                    >Fecha:</label
                  >
                  <input
                    type="text"
                    id="eventDate"
                    readonly
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2 cursor-pointer"
                  />
                  <div
                    id="datePickerCalendarEvent"
                    class="absolute bg-white border border-gray-300 rounded-lg shadow-lg z-10 p-2 mt-1 hidden"
                  >
                    <div class="flex items-center justify-between mb-2">
                      <button
                        type="button"
                        id="prevDatePickerMonthEvent"
                        class="text-[#334155] p-1 rounded-full hover:bg-gray-100"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18px"
                          height="18px"
                          fill="currentColor"
                          viewBox="0 0 256 256"
                        >
                          <path
                            d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"
                          ></path>
                        </svg>
                      </button>
                      <span
                        id="datePickerMonthDisplayEvent"
                        class="font-bold text-[#334155]"
                      ></span>
                      <button
                        type="button"
                        id="nextDatePickerMonthEvent"
                        class="text-[#334155] p-1 rounded-full hover:bg-gray-100"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="18px"
                          height="18px"
                          fill="currentColor"
                          viewBox="0 0 256 256"
                        >
                          <path
                            d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"
                          ></path>
                        </svg>
                      </button>
                    </div>
                    <div
                      class="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 mb-1"
                    >
                      <span>Lu</span><span>Ma</span><span>Mi</span
                      ><span>Ju</span><span>Vi</span><span>Sa</span
                      ><span>Do</span>
                    </div>
                    <div
                      id="datePickerDaysEvent"
                      class="grid grid-cols-7 gap-0.5 text-sm"
                    ></div>
                  </div>
                </div>
                <div>
                  <label
                    for="eventTitle"
                    class="block text-sm font-medium text-[#334155]"
                    >Evento:</label
                  >
                  <input
                    type="text"
                    id="eventTitle"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2"
                  />
                </div>
                <div>
                  <label
                    for="eventDescription"
                    class="block text-sm font-medium text-[#334155]"
                    >Descripción (Opcional):</label
                  >
                  <textarea
                    id="eventDescription"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 px-3 py-2"
                  ></textarea>
                </div>
                <div class="flex space-x-4">
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="eventTypePersonal"
                      value="Personal"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Personal</span>
                  </label>
                  <label
                    class="flex items-center text-sm font-medium text-[#334155]"
                  >
                    <input
                      type="checkbox"
                      id="eventTypeAcademic"
                      value="Académico"
                      class="rounded text-blue-600 focus:ring-blue-500"
                    />
                    <span class="ml-2">Académico</span>
                  </label>
                </div>
                <div class="flex justify-end space-x-3">
                  <button
                    type="button"
                    id="cancelAddEvent"
                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"
                  >
                    Cancelar
                  </button>
                  <button
                    type="submit"
                    id="saveEvent"
                    class="px-4 py-2 rounded-lg text-sm font-semibold bg-[#6A8EEB] text-white hover:bg-[#5a7ddc] transition-colors"
                  >
                    Guardar Evento
                  </button>
                </div>
              </form>
            </div>

            <div class="mt-4 border-t border-slate-200 pt-4">
              <p class="text-[#4e7497] italic">Lista de eventos...</p>
              <div
                id="eventsListContainer"
                class="flex flex-col gap-2 p-2"
              ></div>
            </div>
          </div>
          <div
            id="settings-section"
            class="layout-content-container w-full flex-col max-w-[960px] flex-1 hidden bg-white rounded-xl shadow-lg p-4 sm:p-6"
          >
            <h2
              class="text-slate-800 text-3xl font-bold leading-tight tracking-[-0.015em] mb-8"
            >
              Ajustes de Cuenta
            </h2>
            <div class="space-y-8">
                <div>
                    <h3 class="text-xl font-semibold text-slate-700 pb-2 border-b border-slate-200 mb-4">Personalización</h3>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <img id="current-avatar-img" class="size-16 rounded-full" src="https://placehold.co/64x64/E2E8F0/475569?text=SM" alt="Avatar actual">
                            <div>
                                <p class="font-semibold text-slate-600">Imagen de Perfil</p>
                                <p class="text-sm text-slate-500">Elige un avatar que te represente.</p>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="change-avatar-btn" class="px-4 py-2 rounded-lg text-sm font-semibold bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">
                                Cambiar
                            </button>
                            <div id="avatar-modal" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl z-20 p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Elige tu Avatar</h3>
                                    <button id="close-avatar-modal-btn" class="text-gray-400 hover:text-gray-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256" fill="currentColor"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31l-66.34,66.35a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66a8,8,0,0,1,11.32-11.32L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
                                    </button>
                                </div>
                                <div id="avatar-options-list" class="grid grid-cols-4 gap-3 max-h-60 overflow-y-auto">
                                    <!-- Avatars will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Sección de Materias -->
                <div>
                    <h3 class="text-xl font-semibold text-slate-700 pb-2 border-b border-slate-200 mb-4">Mis Materias</h3>
                    <div class="space-y-4">
                        <div id="subjectsListContainer" class="space-y-2">
                            <!-- Las materias se cargarán aquí -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="subjectNameInput" placeholder="Nueva materia" class="flex-grow mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 h-10 px-3 py-2">
                            <button id="addSubjectBtn" class="px-4 py-2 rounded-lg text-sm font-semibold bg-slate-600 text-white hover:bg-slate-700 transition-colors">
                                Añadir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="authModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full mx-4 text-center">
        <div class="flex justify-end">
             <button
            id="closeAuthModalBtn"
            class="text-gray-400 hover:text-gray-600"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 256 256"
              fill="currentColor"
            >
              <path
                d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31l-66.34,66.35a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66a8,8,0,0,1,11.32-11.32L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"
              ></path>
            </svg>
          </button>
        </div>
        <h3 id="authTitle" class="text-2xl font-bold text-[#334155] mb-2"></h3>
        <p id="authMessage" class="text-gray-500 mb-6"></p>
        <div id="authContent" class="mt-4"></div>
      </div>
    </div>
    
    <div id="taskDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 relative overflow-hidden">
        <div id="modalPriorityIndicator" class="absolute left-0 top-0 bottom-0 w-1.5"></div>
        <div class="pl-5 pr-6 py-6">
            <button id="closeTaskDetailModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256" fill="currentColor"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31l-66.34,66.35a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66a8,8,0,0,1,11.32-11.32L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
            </button>
            <div class="flex items-center gap-4 mb-4">
              <div id="modalTaskIcon" class="flex items-center justify-center rounded-lg bg-gray-100 shrink-0 size-12 text-[#334155]"></div>
              <div>
                <h3 id="modalTaskTitle" class="text-2xl font-bold text-[#334155]"></h3>
                <p id="modalTaskDate" class="text-sm text-gray-500"></p>
              </div>
            </div>
            <div class="border-t border-gray-200 pt-4 mb-4">
              <p class="text-base text-gray-700" id="modalTaskDescription"></p>
            </div>
            <div class="flex justify-between items-center mt-6 border-t border-gray-200 pt-4">
                <p id="modalTaskCategory" class="text-sm font-semibold text-gray-600 mr-3"></p>
                <div class="flex gap-3">
                    <button id="editTaskBtn" title="Editar Tarea" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,164v40a16,16,0,0,0,16,16H92a15.86,15.86,0,0,0,12-4.69L227.31,96a16,16,0,0,0,0-22.63ZM88,192H56V168l88-88,32,32ZM184,88,152,56l24-24,32,32Z"></path></svg>
                        Editar
                    </button>
                    <button id="deleteTaskBtn" title="Borrar Tarea" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-red-100 text-red-800 hover:bg-red-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96ZM192,208H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>
                        Borrar
                    </button>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- New Assignment Detail Modal -->
    <div id="assignmentDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 relative overflow-hidden">
            <div id="modalAssignmentPriorityIndicator" class="absolute left-0 top-0 bottom-0 w-1.5"></div>
            <div class="pl-5 pr-6 py-6">
                <button id="closeAssignmentDetailModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256" fill="currentColor"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31l-66.34,66.35a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66a8,8,0,0,1,11.32-11.32L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
                </button>
                <div class="flex items-center gap-4 mb-4">
                    <div id="modalAssignmentIcon" class="flex items-center justify-center rounded-lg bg-gray-100 shrink-0 size-12 text-[#334155]"></div>
                    <div>
                        <h3 id="modalAssignmentTitle" class="text-2xl font-bold text-[#334155]"></h3>
                        <p id="modalAssignmentDate" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-4 mb-4">
                    <p class="text-base text-gray-700" id="modalAssignmentDescription"></p>
                </div>
                <div class="flex justify-between items-center mt-6 border-t border-gray-200 pt-4">
                    <p id="modalAssignmentCategory" class="text-sm font-semibold text-gray-600 mr-3"></p>
                    <div class="flex gap-3">
                        <button id="editAssignmentBtn" title="Editar Trabajo Práctico" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,164v40a16,16,0,0,0,16,16H92a15.86,15.86,0,0,0,12-4.69L227.31,96a16,16,0,0,0,0-22.63ZM88,192H56V168l88-88,32,32ZM184,88,152,56l24-24,32,32Z"></path></svg>
                            Editar
                        </button>
                        <button id="deleteAssignmentBtn" title="Borrar Trabajo Práctico" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-red-100 text-red-800 hover:bg-red-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96ZM192,208H64V64H192Z"></path></svg>
                            Borrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Exam Detail Modal -->
    <div id="examDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 relative overflow-hidden">
            <div id="modalExamPriorityIndicator" class="absolute left-0 top-0 bottom-0 w-1.5"></div>
            <div class="pl-5 pr-6 py-6">
                <button id="closeExamDetailModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 256 256" fill="currentColor"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31l-66.34,66.35a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66a8,8,0,0,1,11.32-11.32L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
                </button>
                <div class="flex items-center gap-4 mb-4">
                    <div id="modalExamIcon" class="flex items-center justify-center rounded-lg bg-gray-100 shrink-0 size-12 text-[#334155]"></div>
                    <div>
                        <h3 id="modalExamTitle" class="text-2xl font-bold text-[#334155]"></h3>
                        <p id="modalExamDate" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-4 mb-4">
                    <p class="text-base text-gray-700" id="modalExamDescription"></p>
                </div>
                <div class="flex justify-between items-center mt-6 border-t border-gray-200 pt-4">
                    <p id="modalExamCategory" class="text-sm font-semibold text-gray-600 mr-3"></p>
                    <div class="flex gap-3">
                        <button id="editExamBtnModal" title="Editar Examen" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,164v40a16,16,0,0,0,16,16H92a15.86,15.86,0,0,0,12-4.69L227.31,96a16,16,0,0,0,0-22.63ZM88,192H56V168l88-88,32,32ZM184,88,152,56l24-24,32,32Z"></path></svg>
                            Editar
                        </button>
                        <button id="deleteExamBtnModal" title="Borrar Examen" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-red-100 text-red-800 hover:bg-red-200 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96ZM192,208H64V64H192Z"></path></svg>
                            Borrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="customConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center hidden" style="z-index: 60;">
      <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 text-center">
        <h3 class="text-lg font-bold text-gray-800 mb-2">Confirmar Acción</h3>
        <p id="customConfirmMessage" class="text-gray-600 mb-6">¿Estás seguro?</p>
        <div class="flex justify-center gap-4">
          <button id="confirmCancelBtn" class="px-6 py-2 rounded-lg text-sm font-semibold bg-gray-200 text-gray-800 hover:bg-gray-300 transition-colors">Cancelar</button>
          <button id="confirmOkBtn" class="px-6 py-2 rounded-lg text-sm font-semibold bg-red-600 text-white hover:bg-red-700 transition-colors">Confirmar</button>
        </div>
      </div>
    </div>

    <script type="module">
      // [GLOBAL] :: IMPORTS - Módulos de Firebase para autenticación y base de datos.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
          getAuth, 
          GoogleAuthProvider, 
          signInWithPopup, 
          onAuthStateChanged,
          signOut
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        query,
        where,
        doc,
        deleteDoc,
        updateDoc,
        getDocs,
        getDoc,
        setDoc
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // [GLOBAL] :: CONFIG :: firebaseConfig - Configuración de la aplicación Firebase.
      const firebaseConfig = {
        apiKey: "AIzaSyBT0y6DpXqZncgmMvFINj1VfhaqULTWdco",
        authDomain: "smateagenda.firebaseapp.com",
        projectId: "smateagenda",
        storageBucket: "smateagenda.appspot.com",
        messagingSenderId: "700255694650",
        appId: "1:700255694650:web:fc7294a42839d1ebd26a03",
        measurementId: "G-Y8WJXLVJBE"
      };

      // [GLOBAL] :: STATE :: Variable Declarations - Inicialización de variables globales para estado y servicios.
      let app, db, auth;
      let userId = null; 
      let userEvents = [], userSubjects = [];
      let firestoreUnsubscribe = null, subjectsUnsubscribe = null;
      let currentEditingTaskId = null, currentEditingAssignmentId = null, currentEditingExamId = null;
      let currentMonth = new Date().getMonth(), currentYear = new Date().getFullYear();
      const today = new Date();
      let selectedDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      let currentWeekStartDate = getMonday(today);
      let taskDatePickerState = { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDay: null };
      let assignmentDatePickerState = { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDay: null };
      let examDatePickerState = { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDay: null };
      let eventDatePickerState = { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), selectedDay: null };
      
      // [TASKS & ASSIGNMENTS] :: STATE :: Variables para el ordenamiento.
      let taskSortCriteria = 'priority', assignmentSortCriteria = 'priority', examSortCriteria = 'priority';
      let taskSortDirection = 'asc', assignmentSortDirection = 'asc', examSortDirection = 'asc';
      let showCompletedTasks = true, showCompletedAssignments = true, showCompletedExams = true;

      // [DOM ELEMENTS] :: Declarations
      let monthDisplay, calendarDaysMonth, prevMonthBtn, nextMonthBtn, weekDisplay, calendarDaysWeek, prevWeekBtn, nextWeekBtn, dayDisplay, currentDayNameDisplay, calendarDaysDay, prevDayBtn, nextDayBtn;
      let navLinks, sections, calendarViewButtons;
      let upcomingEventsContainer, selectedDayEventsContainer, selectedDayTitle, monthEventsTitle, monthEventsContainer, weekEventsTitle, weekEventsContainer;
      let addTaskFormContainer, showAddTaskModalBtn, cancelAddTaskBtn, saveTaskBtn, taskForm, taskDateInput, taskDescriptionInput, taskTypeIndividualCheckbox, taskTypeGroupCheckbox, datePickerCalendar, datePickerMonthDisplay, datePickerDays, prevDatePickerMonthBtn, nextDatePickerMonthBtn, tasksListContainer, taskSubjectSelect;
      let addAssignmentFormContainer, showAddAssignmentModalBtn, cancelAddAssignmentBtn, saveAssignmentBtn, assignmentForm, assignmentDateInput, assignmentDescriptionInput, assignmentTypeIndividualCheckbox, assignmentTypeGroupCheckbox, datePickerCalendarAssignment, datePickerMonthDisplayAssignment, datePickerDaysAssignment, prevDatePickerMonthAssignmentBtn, nextDatePickerMonthAssignmentBtn, assignmentsListContainer, assignmentSubjectSelect;
      let addExamFormContainer, showAddExamModalBtn, cancelAddExamBtn, saveExamBtn, examForm, examDateInput, examTitleInput, examDescriptionInput, examTypeOralCheckbox, examTypeWrittenCheckbox, datePickerCalendarExam, datePickerMonthDisplayExam, datePickerDaysExam, prevDatePickerMonthExamBtn, nextDatePickerMonthExamBtn, examsListContainer;
      let addEventFormContainer, showAddEventModalBtn, cancelAddEventBtn, saveEventBtn, eventForm, eventDateInput, eventTitleInput, eventDescriptionInput, eventTypePersonalCheckbox, eventTypeAcademicCheckbox, datePickerCalendarEvent, datePickerMonthDisplayEvent, datePickerDaysEvent, prevDatePickerMonthEventBtn, nextDatePickerMonthEventBtn, eventsListContainer;
      let successMessage, assignmentSuccessMessage, examSuccessMessage, eventSuccessMessage;
      let authModal, closeAuthModalBtn, userIconContainer, userIconContainerMobile, authContent, welcomeMessage, authMessage, authTitle;
      let hamburgerBtn, mobileMenu, closeMobileMenuBtn, bellBtn;
      let taskDetailModal, closeTaskDetailModalBtn, modalTaskIcon, modalTaskTitle, modalTaskDate, modalTaskDescription, editTaskBtn, deleteTaskBtn, modalTaskCategory, modalPriorityIndicator;
      // New Assignment Detail Modal elements
      let assignmentDetailModal, closeAssignmentDetailModalBtn, modalAssignmentIcon, modalAssignmentTitle, modalAssignmentDate, modalAssignmentDescription, editAssignmentBtn, deleteAssignmentBtn, modalAssignmentCategory, modalAssignmentPriorityIndicator;
      // New Exam Detail Modal elements
      let examDetailModal, closeExamDetailModalBtn, modalExamIcon, modalExamTitle, modalExamDate, modalExamDescription, editExamBtnModal, deleteExamBtnModal, modalExamCategory, modalExamPriorityIndicator;


      let sortCriteriaBtn, sortDirectionBtn, sortDropdown, sortCriteriaText, sortDirectionIcon, toggleCompletedBtn, eyeOpenIcon, eyeClosedIcon;
      let assignmentSortCriteriaBtn, assignmentSortDirectionBtn, assignmentSortDropdown, assignmentSortCriteriaText, assignmentSortDirectionIcon, assignmentToggleCompletedBtn, assignmentEyeOpenIcon, assignmentEyeClosedIcon;
      let examSortCriteriaBtn, examSortDirectionBtn, examSortDropdown, examSortCriteriaText, examSortDirectionIcon, examToggleCompletedBtn, examEyeOpenIcon, examEyeClosedIcon;

      let settingsSection, changeAvatarBtn, avatarModal, closeAvatarModalBtn, avatarOptionsList, currentAvatarImg;
      let subjectsListContainer, subjectNameInput, addSubjectBtn;

      const iconSVG = {
        BookOpen: `<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,48H160a40,40,0,0,0-32,16A40,40,0,0,0,96,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H96a24,24,0,0,1,24,24,8,8,0,0,0,16,0,24,24,0,0,1,24-24h64a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM96,192H32V64H96a24,24,0,0,1,24,24V200A39.81,39.81,0,0,0,96,192Zm128,0H160a39.81,39.81,0,0,0-24,8V88a24,24,0,0,1,24-24h64Z"></path></svg>`,
        TestTube: `<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M237.66,86.34l-60-60a8,8,0,0,0-11.32,0L37.11,155.57a44.77,44.77,0,0,0,63.32,63.32L212.32,107l22.21-7.4a8,8,0,0,0,3.13-13.25ZM89.11,207.57a28.77,28.77,0,0,1-40.68-40.68l28.8-28.8c8.47-2.9,21.75-4,39.07,5,10.6,5.54,20.18,8,28.56,8.73ZM205.47,92.41a8,8,0,0,0-3.13,1.93l-39.57,39.57c-8.47,2.9-21.75,4-39.07-5-10.6-5.54-20.18-8-28.56-8.73L172,43.31,217.19,88.5Z"></path></svg>`,
        Flask: `<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M221.69,199.77,160,96.92V40h8a8,8,0,0,0,0-16H88a8,8,0,0,0,0,16h8V96.92L34.31,199.77A16,16,0,0,0,48,224H208a16,16,0,0,0,13.72-24.23ZM110.86,103.25A7.93,7.930,0,0,0,112,99.14V40h32V99.14a7.93,7.93,0,0,0,1.14,4.11L183.36,167c-12,2.37-29.07,1.37-51.75-10.11-15.91-8.05-31.05-12.32-45.22-12.81ZM48,208l28.54-47.58c14.25-1.74,30.31,1.85,47.82,10.72,19,9.61,35,12.88,48,12.88a69.89,69.89,0,0,0,19.55-2.7L208,208Z"></path></svg>`,
        Users: `<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M232,120H216V96a40,40,0,0,0-40-40H80A40,40,0,0,0,40,96v24H24a8,8,0,0,0,0,16H40v24a40,40,0,0,0,40,40h96a40,40,0,0,0,40-40V136h16a8,8,0,0,0,0-16ZM56,96a24,24,0,1,1,24-24h96a24,24,0,1,1,24,24v24H56ZM200,160a24,24,0,1,1-24,24H80a24,24,0,1,1-24-24V136H200Z"></path></svg>`,
        Presentation: `<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,40H32a16,16,0,0,0-16,16V200a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V56A16,16,0,0,0,224,40Zm0,16V176H32V56ZM128,144a8,8,0,0,1-8-8V88a8,8,0,0,1,16,0v48A8,8,0,0,1,128,144Zm-32,0a8,8,0,0,1-8-8V88a8,8,0,0,1,16,0v48A8,8,0,0,1,96,144Zm64,0a8,8,0,0,1-8-8V88a8,8,0,0,1,16,0v48A8,8,0,0,1,160,144Z"></path></svg>`,
        Chat: `<svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M232,120A104,104,0,0,1,45.25,200.41L24.89,215a8,8,0,0,0-.73,11.39A8,8,0,0,0,32,232a8,8,0,0,0,5.65-2.34l20.4-20.4a104,104,0,1,0,163.92-89.26ZM128,216a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Z"></path></svg>`,
      };
      const guestIconSvg = `<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="grad-guest" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#6A8EEB" /><stop offset="100%" stop-color="#A267F5" /></linearGradient></defs><circle cx="12" cy="12" r="11" stroke="url(#grad-guest)" stroke-width="2" fill="none"/><path d="M12 12c1.66 0 3-1.34 3-3S13.66 6 12 6s-3 1.34-3 3 1.34 3 3 3zm0 2c-2.67 0-8 1.34-8 4v1h16v-1c0-2.66-5.33-4-8-4z" fill="url(#grad-guest)"/></svg>`;

      function getEventBackgroundColor(eventType) {
        switch (eventType) {
          case "task": return "bg-[#A3D9E9]";
          case "exam": return "bg-[#FFD7A3]";
          case "assignment": return "bg-[#C3E6CB]";
          case "other": default: return "bg-[#E0BBE4]";
        }
      }

      function parseDateString(dateStr) { return new Date(dateStr.replace(/-/g, '/')); }

      function isSameDay(d1, d2) {
        if (!d1 || !d2) return false;
        return (d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate());
      }

      function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.getFullYear(), d.getMonth(), diff);
      }
      
      function renderMonthCalendar() {
        if (!monthDisplay || !calendarDaysMonth) return;
        calendarDaysMonth.innerHTML = "";
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        monthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        let startDayOffset = firstDayOfMonth.getDay();
        startDayOffset = startDayOffset === 0 ? 6 : startDayOffset - 1;
        for (let i = 0; i < startDayOffset; i++) { calendarDaysMonth.appendChild(document.createElement("div")).className = "h-12 w-full border-b border-r border-slate-200"; }
        for (let day = 1; day <= daysInMonth; day++) {
          const dayButton = document.createElement("button");
          dayButton.className = "h-12 w-full text-sm font-medium leading-normal border-b border-r border-slate-200 hover:bg-slate-100 transition-colors relative";
          const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          dayButton.setAttribute("data-date", dateString);
          dayButton.innerHTML = `<div class="flex size-full items-center justify-center rounded-full">${day}</div>`;
          calendarDaysMonth.appendChild(dayButton);
          const dayNumberDiv = dayButton.querySelector("div");
          const currentDayFullDate = new Date(currentYear, currentMonth, day);
          applyDayStyling(dayNumberDiv, currentDayFullDate);
          // Filter out completed tasks, assignments, and exams from calendar view
          const eventsOnThisDay = userEvents.filter((event) => {
  return (
    isSameDay(parseDateString(event.date), currentDayFullDate) &&
    !event.completed &&
    (event.type === 'task' || event.type === 'assignment' || event.type === 'exam')
  );
});
          if (eventsOnThisDay.length > 0) {
            const eventDotContainer = document.createElement("div");
            eventDotContainer.className = "absolute bottom-1 left-1/2 -translate-x-1/2 flex gap-1";
            eventsOnThisDay.slice(0, 3).forEach((event) => {
              const eventDot = document.createElement("span");
              eventDot.className = `size-2 rounded-full ${getEventBackgroundColor(event.type).split(" ")[0]}`;
              eventDotContainer.appendChild(eventDot);
            });
            dayButton.appendChild(eventDotContainer);
          }
          dayButton.addEventListener("click", (event) => { handleDayClick(event.currentTarget); });
        }
      }
      
      function renderWeekCalendar() {
        if (!weekDisplay || !calendarDaysWeek) return;
        calendarDaysWeek.innerHTML = "";
        const startOfWeek = getMonday(currentWeekStartDate);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        weekDisplay.textContent = `${startOfWeek.getDate()} de ${startOfWeek.toLocaleString("es-ES", { month: "short" })} - ${endOfWeek.getDate()} de ${endOfWeek.toLocaleString("es-ES", { month: "short" })} ${endOfWeek.getFullYear()}`;
        for (let i = 0; i < 7; i++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + i);
          const dayButton = document.createElement("button");
          dayButton.className = "h-[86px] w-full text-[#334155] text-sm font-medium leading-normal border-b border-r border-slate-200 hover:bg-slate-100 transition-colors relative flex flex-col items-center justify-start pt-2";
          const dateString = `${currentDay.getFullYear()}-${String(currentDay.getMonth() + 1).padStart(2, "0")}-${String(currentDay.getDate()).padStart(2, "0")}`;
          dayButton.setAttribute("data-date", dateString);
          dayButton.innerHTML = `<div class="flex size-8 items-center justify-center rounded-full">${currentDay.getDate()}</div>`;
          calendarDaysWeek.appendChild(dayButton);
          const dayNumberDiv = dayButton.querySelector("div");
          applyDayStyling(dayNumberDiv, currentDay);
          // Filter out completed tasks, assignments, and exams from calendar view
          const eventsOnThisDay = userEvents.filter((event) => 
            isSameDay(parseDateString(event.date), currentDay) &&
            !(event.completed && (event.type === 'task' || event.type === 'assignment' || event.type === 'exam'))
          );
          if (eventsOnThisDay.length > 0) {
            const eventDotContainer = document.createElement("div");
            eventDotContainer.className = "flex gap-1 mt-1";
            eventsOnThisDay.slice(0, 3).forEach((event) => {
              const eventDot = document.createElement("span");
              eventDot.className = `size-2 rounded-full ${getEventBackgroundColor(event.type).split(" ")[0]}`;
              eventDotContainer.appendChild(eventDot);
            });
            dayButton.appendChild(eventDotContainer);
          }
          dayButton.addEventListener("click", (event) => { handleDayClick(event.currentTarget); });
        }
      }
      
      function renderDayCalendar() {
        if (!dayDisplay || !currentDayNameDisplay || !calendarDaysDay) return;
        calendarDaysDay.innerHTML = "";
        dayDisplay.textContent = `${selectedDay.getDate()} de ${selectedDay.toLocaleString("es-ES", { month: "long" })} ${selectedDay.getFullYear()}`;
        currentDayNameDisplay.textContent = selectedDay.toLocaleString("es-ES", { weekday: "short" }).substring(0, 2).toUpperCase();
        const dayButton = document.createElement("button");
        dayButton.className = "h-[86px] w-full text-[#334155] text-sm font-medium leading-normal border-b border-r border-slate-200 hover:bg-slate-100 transition-colors relative flex flex-col items-center justify-start pt-2";
        const dateString = `${selectedDay.getFullYear()}-${String(selectedDay.getMonth() + 1).padStart(2, "0")}-${String(selectedDay.getDate()).padStart(2, "0")}`;
        dayButton.setAttribute("data-date", dateString);
        dayButton.innerHTML = `<div class="flex size-8 items-center justify-center rounded-full">${selectedDay.getDate()}</div>`;
        calendarDaysDay.appendChild(dayButton);
        const dayNumberDiv = dayButton.querySelector("div");
        applyDayStyling(dayNumberDiv, selectedDay);
        // Filter out completed tasks, assignments, and exams from calendar view
        const eventsOnThisDay = userEvents.filter((event) => 
          isSameDay(parseDateString(event.date), selectedDay) &&
          !(event.completed && (event.type === 'task' || event.type === 'assignment' || event.type === 'exam'))
        );
        if (eventsOnThisDay.length > 0) {
          const eventDotContainer = document.createElement("div");
          eventDotContainer.className = "flex gap-1 mt-1";
          eventsOnThisDay.slice(0, 3).forEach((event) => {
            const eventDot = document.createElement("span");
            eventDot.className = `size-2 rounded-full ${getEventBackgroundColor(event.type).split(" ")[0]}`;
            eventDotContainer.appendChild(eventDot);
          });
          dayButton.appendChild(eventDotContainer);
        }
        dayButton.addEventListener("click", (event) => { handleDayClick(event.currentTarget); });
      }
      
      function applyDayStyling(dayDiv, dayDate) {
        dayDiv.classList.remove("selected-day-bg", "text-white", "font-bold", "text-[#334155]", "text-black");
        const isTodayDay = isSameDay(dayDate, today);
        const isSelectedDay = isSameDay(dayDate, selectedDay);
        if (isSelectedDay) { dayDiv.classList.add("selected-day-bg", "text-black", "font-bold"); } 
        else if (isTodayDay) { dayDiv.classList.add("text-black", "font-bold"); } 
        else { dayDiv.classList.add("text-[#334155]"); }
      }
      
      function handleDayClick(clickedButton) {
        const dateParts = clickedButton.getAttribute("data-date").split("-");
        const newSelectedDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
        if (!isSameDay(selectedDay, newSelectedDate)) {
          selectedDay = newSelectedDate;
          currentMonth = selectedDay.getMonth();
          currentYear = selectedDay.getFullYear();
          currentWeekStartDate = getMonday(selectedDay);
          renderMonthCalendar();
          renderWeekCalendar();
          renderDayCalendar();
          showActiveCalendarViewEvents();
        }
      }
      
      function renderEventsInContainer(containerElement, eventsList, titleElement, noEventsMessage, filterType) {
        if (!containerElement) return;
        containerElement.innerHTML = "";
        if (titleElement) titleElement.classList.remove("hidden");
        containerElement.classList.remove("hidden");
        let filteredEvents = [];
        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        if (filterType === "upcoming") { 
            filteredEvents = eventsList.filter((event) => 
                parseDateString(event.date) >= todayStart && 
                !(event.completed && (event.type === 'task' || event.type === 'assignment' || event.type === 'exam'))
            ); 
        } 
        else if (filterType === "month") { 
            filteredEvents = eventsList.filter((event) => 
                parseDateString(event.date).getMonth() === currentMonth && 
                parseDateString(event.date).getFullYear() === currentYear &&
                !(event.completed && (event.type === 'task' || event.type === 'assignment' || event.type === 'exam'))
            ); 
        } 
        else if (filterType === "week") {
          const startOfWeekNormalized = new Date(currentWeekStartDate.getFullYear(), currentWeekStartDate.getMonth(), currentWeekStartDate.getDate(), 0, 0, 0);
          const endOfWeekNormalized = new Date(currentWeekStartDate.getFullYear(), currentWeekStartDate.getMonth(), currentWeekStartDate.getDate() + 6, 23, 59, 59, 999);
          filteredEvents = eventsList.filter((event) => 
            parseDateString(event.date) >= startOfWeekNormalized && 
            parseDateString(event.date) <= endOfWeekNormalized &&
            !(event.completed && (event.type === 'task' || event.type === 'assignment' || event.type === 'exam'))
          );
        } else if (filterType === "day") { 
            filteredEvents = eventsList.filter((event) => 
                isSameDay(parseDateString(event.date), selectedDay) &&
                !(event.completed && (event.type === 'task' || event.type === 'assignment' || event.type === 'exam'))
            ); 
        }
        filteredEvents.sort((a, b) => parseDateString(a.date) - parseDateString(b.date));
        if (filteredEvents.length === 0) {
          containerElement.innerHTML = `<p class="text-[#4e7497] text-base font-normal leading-normal px-4 py-2">${noEventsMessage}</p>`;
          return;
        }
        filteredEvents.forEach((event) => {
          const eventDate = parseDateString(event.date).toLocaleDateString("es-ES", { day: "numeric", month: "long", year: "numeric" });
          const eventHtml = `<div class="flex items-center gap-4 ${getEventBackgroundColor(event.type)} text-[#334155] px-4 min-h-[72px] py-2 justify-between rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer"><div class="flex items-center justify-center rounded-lg bg-white bg-opacity-75 shrink-0 size-12 text-[#334155]">${iconSVG[event.icon] || ""}</div><div class="flex flex-col justify-center flex-grow"><p class="text-base font-medium leading-normal line-clamp-1">${event.name}</p><p class="text-sm font-normal leading-normal line-clamp-2">${event.subject}</p></div><div class="shrink-0"><p class="text-sm font-normal leading-normal">${eventDate}</p></div></div>`;
          containerElement.insertAdjacentHTML("beforeend", eventHtml);
        });
      }
      
      function renderUpcomingEvents() { if (upcomingEventsContainer) renderEventsInContainer(upcomingEventsContainer, userEvents, null, "No hay eventos próximos.", "upcoming"); }
      
      function renderDayEvents() {
        if (!selectedDayEventsContainer || !selectedDayTitle) return;
        const formattedDate = selectedDay.toLocaleDateString("es-ES", { weekday: "long", day: "numeric", month: "long", year: "numeric" });
        selectedDayTitle.textContent = `Eventos para el ${formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1)}`;
        renderEventsInContainer(selectedDayEventsContainer, userEvents, selectedDayTitle, "No hay eventos para este día.", "day");
      }
      
      function renderMonthEvents() { if (monthEventsContainer && monthEventsTitle) renderEventsInContainer(monthEventsContainer, userEvents, monthEventsTitle, "No hay eventos para este mes.", "month");}
      
      function renderWeekEvents() { if (weekEventsContainer && weekEventsTitle) renderEventsInContainer(weekEventsContainer, userEvents, weekEventsTitle, "No hay eventos para esta semana.", "week");}
      
      // [TASKS] :: RENDER :: renderTasks() - Dibuja la lista de tareas, ordenada por prioridad y luego por fecha.
      function renderTasks() {
        if (!tasksListContainer) return;
        tasksListContainer.innerHTML = "";
        
        const priorityOrder = { high: 1, medium: 2, low: 3 };
        let tasks = userEvents.filter((event) => event.type === "task");

        if (!showCompletedTasks) {
            tasks = tasks.filter(task => !task.completed);
        }

        tasks.sort((a, b) => {
          if (taskSortCriteria === 'priority') {
            const priorityA = priorityOrder[a.priority || 'medium'];
            const priorityB = priorityOrder[b.priority || 'medium'];
            if (priorityA !== priorityB) {
              return taskSortDirection === 'asc' ? priorityA - priorityB : priorityB - priorityA;
            }
          }
          
          const dateA = parseDateString(a.date);
          const dateB = parseDateString(b.date);
          return taskSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
        });

        if (tasks.length === 0) {
            tasksListContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay tareas para mostrar.</p>`;
            return;
        }

        tasks.forEach((task) => {
          const taskDate = parseDateString(task.date).toLocaleDateString("es-ES", { day: "numeric", month: "long" });
          const completedClass = task.completed ? 'completed' : '';
          const taskHtml = `<div class="task-card flex items-center gap-4 ${getEventBackgroundColor(task.type)} text-[#334155] px-4 pl-6 min-h-[72px] py-2 rounded-lg shadow-sm cursor-pointer ${completedClass}" data-task-id="${task.id}">
                                           <div class="priority-indicator priority-${task.priority || 'medium'}"></div>
                                           <div class="flex items-center justify-center rounded-lg bg-white bg-opacity-75 shrink-0 size-12 text-[#334155]">
                                               ${iconSVG[task.icon] || ""}
                                           </div>
                                           <div class="flex flex-col justify-center flex-grow min-w-0">
                                               <p class="text-sm font-semibold leading-normal text-slate-600 truncate">${task.subject || 'General'}</p>
                                               <p class="text-base font-medium leading-normal line-clamp-1">${task.name}</p>
                                           </div>
                                           <div class="shrink-0 flex flex-col items-end justify-between self-stretch py-1">
                                               <div class="flex items-center gap-2">
                                                   <span class="completed-text ${task.completed ? '' : 'invisible'}">completada</span>
                                                   <input type="checkbox" class="completion-checkbox rounded text-blue-600 focus:ring-blue-500" ${task.completed ? 'checked' : ''} data-task-id="${task.id}">
                                               </div>
                                               <p class="text-sm font-normal leading-normal whitespace-nowrap">${taskDate}</p>
                                           </div>
                                       </div>`;
          tasksListContainer.insertAdjacentHTML("beforeend", taskHtml);
        });
      }

      // [ASSIGNMENTS] :: RENDER :: renderAssignments() - Dibuja la lista de trabajos prácticos, incluyendo el indicador de prioridad y el checkbox de completado.
      function renderAssignments() {
        if (!assignmentsListContainer) return;
        assignmentsListContainer.innerHTML = "";
        
        const priorityOrder = { high: 1, medium: 2, low: 3 };
        let assignments = userEvents.filter((event) => event.type === "assignment");

        if (!showCompletedAssignments) {
            assignments = assignments.filter(assignment => !assignment.completed);
        }

        assignments.sort((a, b) => {
          if (assignmentSortCriteria === 'priority') {
            const priorityA = priorityOrder[a.priority || 'medium'];
            const priorityB = priorityOrder[b.priority || 'medium'];
            if (priorityA !== priorityB) {
              return assignmentSortDirection === 'asc' ? priorityA - priorityB : priorityB - priorityA;
            }
          }
          
          const dateA = parseDateString(a.date);
          const dateB = parseDateString(b.date);
          return assignmentSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
        });

        if (assignments.length === 0) {
            assignmentsListContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay trabajos prácticos para mostrar.</p>`;
            return;
        }

        assignments.forEach((assignment) => {
          const assignmentDate = parseDateString(assignment.date).toLocaleDateString("es-ES", { day: "numeric", month: "long" });
          const completedClass = assignment.completed ? 'completed' : '';
          const assignmentHtml = `<div class="assignment-card flex items-center gap-4 ${getEventBackgroundColor(assignment.type)} text-[#334155] px-4 pl-6 min-h-[72px] py-2 rounded-lg shadow-sm cursor-pointer ${completedClass}" data-assignment-id="${assignment.id}">
                                           <div class="priority-indicator priority-${assignment.priority || 'medium'}"></div>
                                           <div class="flex items-center justify-center rounded-lg bg-white bg-opacity-75 shrink-0 size-12 text-[#334155]">
                                               ${iconSVG[assignment.icon] || ""}
                                           </div>
                                           <div class="flex flex-col justify-center flex-grow min-w-0">
                                               <p class="text-sm font-semibold leading-normal text-slate-600 truncate">${assignment.subject || 'General'}</p>
                                               <p class="text-base font-medium leading-normal line-clamp-1">${assignment.name}</p>
                                           </div>
                                           <div class="shrink-0 flex flex-col items-end justify-between self-stretch py-1">
                                               <div class="flex items-center gap-2">
                                                   <span class="completed-text ${assignment.completed ? '' : 'invisible'}">completado</span>
                                                   <input type="checkbox" class="completion-checkbox rounded text-blue-600 focus:ring-blue-500" ${assignment.completed ? 'checked' : ''} data-assignment-id="${assignment.id}">
                                               </div>
                                               <p class="text-sm font-normal leading-normal whitespace-nowrap">${assignmentDate}</p>
                                           </div>
                                       </div>`;
          assignmentsListContainer.insertAdjacentHTML("beforeend", assignmentHtml);
        });
      }
      
      // [EXAMS] :: RENDER :: renderExams() - Dibuja la lista de exámenes, incluyendo el indicador de prioridad y el checkbox de completado.
      function renderExams() {
        if (!examsListContainer) return;
        examsListContainer.innerHTML = "";
        
        const priorityOrder = { high: 1, medium: 2, low: 3 };
        let exams = userEvents.filter((event) => event.type === "exam");

        if (!showCompletedExams) {
            exams = exams.filter(exam => !exam.completed);
        }

        exams.sort((a, b) => {
          if (examSortCriteria === 'priority') {
            const priorityA = priorityOrder[a.priority || 'medium'];
            const priorityB = priorityOrder[b.priority || 'medium'];
            if (priorityA !== priorityB) {
              return examSortDirection === 'asc' ? priorityA - priorityB : priorityB - priorityA;
            }
          }
          
          const dateA = parseDateString(a.date);
          const dateB = parseDateString(b.date);
          return examSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
        });

        if (exams.length === 0) {
            examsListContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay exámenes para mostrar.</p>`;
            return;
        }

        exams.forEach((exam) => {
          const examDate = parseDateString(exam.date).toLocaleDateString("es-ES", { day: "numeric", month: "long" });
          const completedClass = exam.completed ? 'completed' : '';
          const examHtml = `<div class="exam-card flex items-center gap-4 ${getEventBackgroundColor(exam.type)} text-[#334155] px-4 pl-6 min-h-[72px] py-2 rounded-lg shadow-sm cursor-pointer ${completedClass}" data-exam-id="${exam.id}">
                                           <div class="priority-indicator priority-${exam.priority || 'medium'}"></div>
                                           <div class="flex items-center justify-center rounded-lg bg-white bg-opacity-75 shrink-0 size-12 text-[#334155]">
                                               ${iconSVG[exam.icon] || ""}
                                           </div>
                                           <div class="flex flex-col justify-center flex-grow min-w-0">
                                               <p class="text-sm font-semibold leading-normal text-slate-600 truncate">${exam.subject || 'General'}</p>
                                               <p class="text-base font-medium leading-normal line-clamp-1">${exam.name}</p>
                                           </div>
                                           <div class="shrink-0 flex flex-col items-end justify-between self-stretch py-1">
                                               <div class="flex items-center gap-2">
                                                   <span class="completed-text ${exam.completed ? '' : 'invisible'}">completado</span>
                                                   <input type="checkbox" class="completion-checkbox rounded text-blue-600 focus:ring-blue-500" ${exam.completed ? 'checked' : ''} data-exam-id="${exam.id}">
                                               </div>
                                               <p class="text-sm font-normal leading-normal whitespace-nowrap">${examDate}</p>
                                           </div>
                                       </div>`;
          examsListContainer.insertAdjacentHTML("beforeend", examHtml);
        });
      }
      
      function renderEventsSection() {
        if (!eventsListContainer) return;
        eventsListContainer.innerHTML = "";
        const events = userEvents.filter((event) => event.type === "other").sort((a, b) => parseDateString(a.date) - parseDateString(b.date));
        if (events.length > 0) {
          events.forEach((event) => {
            const eventDate = parseDateString(event.date).toLocaleDateString("es-ES", { day: "numeric", month: "long", year: "numeric" });
            const eventHtml = `<div class="flex items-center gap-4 ${getEventBackgroundColor(event.type)} text-[#334155] px-4 min-h-[72px] py-2 justify-between rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer"><div class="flex items-center justify-center rounded-lg bg-white bg-opacity-75 shrink-0 size-12 text-[#334155]">${iconSVG[event.icon] || ""}</div><div class="flex flex-col justify-center flex-grow"><p class="text-base font-medium leading-normal line-clamp-1">${event.name}</p><p class="text-sm font-normal leading-normal line-clamp-2">${event.subject}</p></div><div class="shrink-0"><p class="text-sm font-normal leading-normal">${eventDate}</p></div></div>`;
          eventsListContainer.insertAdjacentHTML("beforeend", eventHtml);
        });
        }
      }
      
      function renderDatePickerCalendar(targetDatePickerDays, targetDatePickerMonthDisplay, datePickerState, targetDateInput) {
        if (!targetDatePickerDays || !targetDatePickerMonthDisplay) return;
        targetDatePickerDays.innerHTML = "";
        const { currentYear, currentMonth } = datePickerState;
        const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        targetDatePickerMonthDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
        let startDayOffset = firstDayOfMonth.getDay();
        startDayOffset = startDayOffset === 0 ? 6 : startDayOffset - 1;
        for (let i = 0; i < startDayOffset; i++) { targetDatePickerDays.appendChild(document.createElement("div")).className = "h-8 w-full"; }
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCell = document.createElement("button");
          dayCell.type = "button";
          dayCell.className = "day-cell text-gray-700 hover:bg-blue-100";
          dayCell.textContent = day;
          dayCell.setAttribute("data-date", `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`);
          const cellDate = new Date(currentYear, currentMonth, day, 0, 0, 0);
          if (datePickerState.selectedDay && isSameDay(cellDate, datePickerState.selectedDay)) { dayCell.classList.add("bg-blue-500", "text-white"); } 
          else if (isSameDay(cellDate, today)) { dayCell.classList.add("border", "border-blue-500"); }
          dayCell.addEventListener("click", () => {
            datePickerState.selectedDay = cellDate;
            targetDateInput.value = cellDate.toLocaleDateString("es-ES");
            targetDatePickerDays.parentElement.classList.add("hidden");
            renderDatePickerCalendar(targetDatePickerDays, targetDatePickerMonthDisplay, datePickerState, targetDateInput);
          });
          targetDatePickerDays.appendChild(dayCell);
        }
      }
      
      function showCustomAlert(message) {
        const alertBox = document.createElement("div");
        alertBox.className = "fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50";
        alertBox.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto text-center"><p class="text-lg font-semibold text-gray-800 mb-4">${message}</p><button id="closeAlertBtn" class="px-5 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button></div>`;
        document.body.appendChild(alertBox);
        document.getElementById("closeAlertBtn").addEventListener("click", () => { document.body.removeChild(alertBox); });
      }

      function showCustomConfirm(message, onConfirm) {
        const modal = document.getElementById('customConfirmModal');
        const msgEl = document.getElementById('customConfirmMessage');
        const okBtn = document.getElementById('confirmOkBtn');
        const cancelBtn = document.getElementById('confirmCancelBtn');
        msgEl.textContent = message;
        modal.classList.remove('hidden');
        const close = () => modal.classList.add('hidden');
        const handleOk = () => { onConfirm(); close(); };
        okBtn.onclick = handleOk;
        cancelBtn.onclick = close;
      }

      function showAlertMessage(message) {
        let existingAlert = document.getElementById('dynamic-alert');
        if (existingAlert) existingAlert.remove();
        const alertBox = document.createElement("div");
        alertBox.id = 'dynamic-alert';
        alertBox.className = "fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg flex items-center space-x-2 z-50 opacity-0 transition-opacity duration-300";
        alertBox.innerHTML = `<span>${message}</span>`;
        document.body.appendChild(alertBox);
        setTimeout(() => alertBox.classList.add("opacity-100"), 10);
        setTimeout(() => {
          alertBox.classList.remove("opacity-100");
          alertBox.addEventListener("transitionend", () => alertBox.parentNode && alertBox.parentNode.removeChild(alertBox), { once: true });
        }, 3000);
      }
      
      function showSuccessMessage(messageElement, text) {
        if (messageElement) {
          messageElement.querySelector("span").textContent = text;
          messageElement.style.setProperty("display", "flex", "important");
          messageElement.classList.remove("hidden");
          setTimeout(() => {
            messageElement.classList.add("hidden");
            messageElement.style.removeProperty("display");
          }, 3000);
        }
      }
      
      function showSection(sectionId) {
        sections.forEach((section) => { section.style.display = section.id === sectionId ? "flex" : "none"; });
        if (sectionId === "panel-section") renderUpcomingEvents();
        else if (sectionId === "tasks-section") renderTasks();
        else if (sectionId === "assignments-section") renderAssignments();
        else if (sectionId === "exams-section") renderExams();
        else if (sectionId === "events-section") renderEventsSection();
      }
      
      function showActiveCalendarViewEvents() {
        [selectedDayEventsContainer, selectedDayTitle, monthEventsContainer, monthEventsTitle, weekEventsContainer, weekEventsTitle].forEach((el) => el && el.classList.add("hidden"));
        if (!document.getElementById("month-view").classList.contains("hidden")) { renderDayEvents(); renderMonthEvents(); } 
        else if (!document.getElementById("week-view").classList.contains("hidden")) { renderDayEvents(); renderWeekEvents(); } 
        else if (!document.getElementById("day-view").classList.contains("hidden")) { renderDayEvents(); }
      }

      function setupFirestoreListeners(uid) {
        if (firestoreUnsubscribe) firestoreUnsubscribe();
        if (subjectsUnsubscribe) subjectsUnsubscribe();
        
        if (uid) {
            // Listener para eventos
            const eventsCollection = collection(db, "events");
            const qEvents = query(eventsCollection, where("userId", "==", uid));
            firestoreUnsubscribe = onSnapshot(qEvents, (querySnapshot) => {
                userEvents = [];
                querySnapshot.forEach((doc) => { userEvents.push({ id: doc.id, ...doc.data() }); });
                renderAllViews();
            }, (error) => {
                console.error("Error al obtener eventos del usuario: ", error);
                showCustomAlert("No se pudieron cargar tus eventos.");
            });

            // Listener para materias
            const subjectsCollection = collection(db, "subjects");
            const qSubjects = query(subjectsCollection, where("userId", "==", uid));
            subjectsUnsubscribe = onSnapshot(qSubjects, (querySnapshot) => {
                userSubjects = [];
                querySnapshot.forEach((doc) => { userSubjects.push({ id: doc.id, ...doc.data() }); });
                renderSubjects();
                populateSubjectsDropdown();
            }, (error) => {
                console.error("Error al obtener materias del usuario: ", error);
                showCustomAlert("No se pudieron cargar tus materias.");
            });

        } else {
            userEvents = [];
            userSubjects = [];
            renderAllViews();
            renderSubjects();
            populateSubjectsDropdown();
        }
      }

      function renderAllViews() {
            renderMonthCalendar();
            renderWeekCalendar();
            renderDayCalendar();
            renderUpcomingEvents();
            showActiveCalendarViewEvents();
            renderTasks();
            renderAssignments();
            renderExams();
            renderEventsSection();
      }

      async function updateUIForAuthState(user) {
        const defaultAvatar = "https://placehold.co/64x64/E2E8F0/475569?text=SM";
        if (user) {
            userId = user.uid;
            authTitle.textContent = user.displayName || 'Usuario';
            authMessage.textContent = user.email;
            
            try {
                const userDocRef = doc(db, "usuarios", user.uid);
                const userDoc = await getDoc(userDocRef);
                const customAvatar = userDoc.exists() ? userDoc.data().avatar : null;
                const finalAvatarUrl = customAvatar || user.photoURL || defaultAvatar;

                const avatarImgHtml = `<img src="${finalAvatarUrl}" alt="Foto de perfil" class="size-full rounded-full object-cover">`;
                userIconContainer.innerHTML = avatarImgHtml;
                userIconContainerMobile.innerHTML = avatarImgHtml;
                currentAvatarImg.src = finalAvatarUrl;
            } catch (error) {
                console.error("Error al cargar el avatar del usuario:", error);
                const avatarImgHtml = `<img src="${user.photoURL || defaultAvatar}" alt="Foto de perfil" class="size-full rounded-full object-cover">`;
                userIconContainer.innerHTML = avatarImgHtml;
                userIconContainerMobile.innerHTML = avatarImgHtml;
                currentAvatarImg.src = user.photoURL || defaultAvatar;
            }

            authContent.innerHTML = `
              <div class="space-y-3 mt-6">
                <button id="accountSettingsBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M128,64a32,32,0,1,0,32,32A32,32,0,0,0,128,64Zm0,48a16,16,0,1,1,16-16A16,16,0,0,1,128,112Zm0-80a88,88,0,1,0,88,88A88.1,88.1,0,0,0,128,32Zm0,160a72,72,0,0,1-55.22-26.32,56,56,0,0,1,110.44,0A72,72,0,0,1,128,192Z"></path></svg>
                  <span>Ajustes de Cuenta</span>
                </button>
                <button id="signOutBtn" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-semibold bg-red-100 text-red-800 hover:bg-red-200 transition-colors">
                   <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M112,216a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V48A16,16,0,0,1,48,32h56a8,8,0,0,1,0,16H56V208h48a8,8,0,0,1,8,8Zm110.34-93.66-40-40a8,8,0,0,0-11.32,11.32L184.69,112H104a8,8,0,0,0,0,16h80.69l-13.67,13.66a8,8,0,0,0,11.32,11.32l40-40A8,8,0,0,0,222.34,122.34Z"></path></svg>
                  <span>Cerrar Sesión</span>
                </button>
              </div>`;

            document.getElementById('signOutBtn').addEventListener('click', () => { signOut(auth).catch(error => console.error("Error al cerrar sesión", error)); });
            document.getElementById('accountSettingsBtn').addEventListener('click', () => {
                closeAuthModal();
                showSection('settings-section');
            });
            
            setupFirestoreListeners(user.uid);
            loadAvatars(); 
        } else {
            userId = null;
            authTitle.textContent = 'Bienvenido';
            authMessage.textContent = "Inicia sesión para continuar";
            userIconContainer.innerHTML = guestIconSvg;
            userIconContainerMobile.innerHTML = guestIconSvg;
            currentAvatarImg.src = defaultAvatar;
            authContent.innerHTML = `<button id="googleSignInBtn" class="w-full flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-sm font-semibold bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 transition-colors"><svg class="size-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_17_80)"><path fill="#4285F4" d="M47.532 24.552c0-1.566-.14-3.09-.405-4.552H24.42v8.604h13.065c-.563 2.76-2.193 5.11-4.685 6.643v5.604h7.222a23.497 23.497 0 0 0 6.915-16.3z"></path><path fill="#34A853" d="M24.42 48.001c6.49 0 11.95-2.14 15.933-5.814l-7.222-5.604c-2.14 1.44-4.88 2.29-8.71 2.29-6.705 0-12.38-4.51-14.42-10.52H2.66v5.78A24.002 24.002 0 0 0 24.42 48z"></path><path fill="#FBBC05" d="M9.999 28.36c-.62-1.84-.97-3.8-.97-5.81s.35-3.97.97-5.81V11.04H2.66a24.002 24.002 0 0 0 0 25.92L10 28.36z"></path><path fill="#EA4335" d="M24.42 9.182c3.52 0 6.705 1.215 9.21 3.63l6.41-6.41C36.366 2.53 30.911 0 24.42 0A24.002 24.002 0 0 0 2.66 11.04l7.34 5.7A14.23 14.23 0 0 1 24.42 9.18Z"></path></g><defs><clipPath id="clip0_17_80"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg><span>Continuar con Google</span></button>`;
            document.getElementById('googleSignInBtn').addEventListener('click', () => {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider).catch(error => console.error("Error de inicio de sesión con Google", error));
            });
            setupFirestoreListeners(null);
        }
      }
      
      function prepareTaskFormForAdd() {
        currentEditingTaskId = null;
        taskForm.reset();
        taskDatePickerState.selectedDay = null;
        taskDateInput.value = '';
        addTaskFormContainer.querySelector('h3').textContent = 'Añadir Nueva Tarea';
        saveTaskBtn.textContent = 'Guardar Tarea';
        const priorityButtons = document.querySelectorAll('#priority-group-final .priority-btn');
        const priorityOutput = document.getElementById('priority-output');
        priorityButtons.forEach(btn => btn.classList.remove('active', 'low', 'medium', 'high'));
        priorityOutput.classList.add('opacity-0');
        priorityOutput.textContent = '';
      }

      function hideAndResetTaskForm() {
        addTaskFormContainer.classList.add('hidden');
        prepareTaskFormForAdd();
      }

      function openTaskFormForEdit(taskId) {
        const task = userEvents.find(e => e.id === taskId);
        if (!task) { console.error("Tarea no encontrada para editar"); return; }
        closeTaskDetailModal();
        currentEditingTaskId = taskId;
        taskSubjectSelect.value = task.subject || "";
        taskDescriptionInput.value = task.name || "";
        const taskDate = parseDateString(task.date);
        taskDatePickerState.selectedDay = taskDate;
        taskDatePickerState.currentMonth = taskDate.getMonth();
        taskDatePickerState.currentYear = taskDate.getFullYear();
        taskDateInput.value = taskDate.toLocaleDateString("es-ES");
        renderDatePickerCalendar(datePickerDays, datePickerMonthDisplay, taskDatePickerState, taskDateInput);
        taskTypeIndividualCheckbox.checked = (task.category === "Individual");
        taskTypeGroupCheckbox.checked = (task.category === "Grupal");
        const priorityButtons = document.querySelectorAll('#priority-group-final .priority-btn');
        const priorityOutput = document.getElementById('priority-output');
        priorityButtons.forEach(btn => btn.classList.remove('active', 'low', 'medium', 'high'));
        priorityOutput.classList.add('opacity-0');
        if (task.priority) {
            const priorityBtn = document.querySelector(`#priority-group-final .priority-btn[data-priority="${task.priority}"]`);
            if (priorityBtn) {
                priorityBtn.classList.add('active', task.priority);
                const priorityName = task.priority === 'low' ? 'Baja' : task.priority === 'medium' ? 'Media' : 'Alta';
                priorityOutput.textContent = priorityName;
                priorityOutput.classList.remove('opacity-0');
            }
        }
        addTaskFormContainer.querySelector('h3').textContent = 'Editar Tarea';
        saveTaskBtn.textContent = 'Guardar Modificación';
        addTaskFormContainer.classList.remove('hidden');
      }

      // [ASSIGNMENTS] :: FORM_PREP :: prepareAssignmentFormForAdd() - Prepara el formulario de trabajos prácticos para añadir uno nuevo.
      function prepareAssignmentFormForAdd() {
        currentEditingAssignmentId = null;
        assignmentForm.reset();
        assignmentDatePickerState.selectedDay = null;
        assignmentDateInput.value = '';
        addAssignmentFormContainer.querySelector('h3').textContent = 'Añadir Nuevo Trabajo Práctico';
        saveAssignmentBtn.textContent = 'Guardar Trabajo Práctico';
        const priorityButtons = document.querySelectorAll('#assignment-priority-group-final .priority-btn');
        const priorityOutput = document.getElementById('assignment-priority-output');
        priorityButtons.forEach(btn => btn.classList.remove('active', 'low', 'medium', 'high'));
        priorityOutput.classList.add('opacity-0');
        priorityOutput.textContent = '';
      }

      // [ASSIGNMENTS] :: FORM_HIDE :: hideAndResetAssignmentForm() - Oculta y resetea el formulario de trabajos prácticos.
      function hideAndResetAssignmentForm() {
        addAssignmentFormContainer.classList.add('hidden');
        prepareAssignmentFormForAdd();
      }

      // [ASSIGNMENTS] :: FORM_EDIT :: openAssignmentFormForEdit() - Rellena el formulario con los datos de un trabajo práctico para editarlo.
      function openAssignmentFormForEdit(assignmentId) {
        const assignment = userEvents.find(e => e.id === assignmentId);
        if (!assignment) { console.error("Trabajo práctico no encontrado para editar"); return; }
        closeAssignmentDetailModal();
        currentEditingAssignmentId = assignmentId;
        assignmentSubjectSelect.value = assignment.subject || "";
        assignmentDescriptionInput.value = assignment.name || "";
        const assignmentDate = parseDateString(assignment.date);
        assignmentDatePickerState.selectedDay = assignmentDate;
        assignmentDatePickerState.currentMonth = assignmentDate.getMonth();
        assignmentDatePickerState.currentYear = assignmentDate.getFullYear();
        assignmentDateInput.value = assignmentDate.toLocaleDateString("es-ES");
        renderDatePickerCalendar(datePickerDaysAssignment, datePickerMonthDisplayAssignment, assignmentDatePickerState, assignmentDateInput);
        assignmentTypeIndividualCheckbox.checked = (assignment.category === "Individual");
        assignmentTypeGroupCheckbox.checked = (assignment.category === "Grupal");
        const priorityButtons = document.querySelectorAll('#assignment-priority-group-final .priority-btn');
        const priorityOutput = document.getElementById('assignment-priority-output');
        priorityButtons.forEach(btn => btn.classList.remove('active', 'low', 'medium', 'high'));
        priorityOutput.classList.add('opacity-0');
        if (assignment.priority) {
            const priorityBtn = document.querySelector(`#assignment-priority-group-final .priority-btn[data-priority="${assignment.priority}"]`);
            if (priorityBtn) {
                priorityBtn.classList.add('active', assignment.priority);
                const priorityName = assignment.priority === 'low' ? 'Baja' : assignment.priority === 'medium' ? 'Media' : 'Alta';
                priorityOutput.textContent = priorityName;
                priorityOutput.classList.remove('opacity-0');
            }
        }
        addAssignmentFormContainer.querySelector('h3').textContent = 'Editar Trabajo Práctico';
        saveAssignmentBtn.textContent = 'Guardar Modificación';
        addAssignmentFormContainer.classList.remove('hidden');
      }

      // [EXAMS] :: FORM_PREP :: prepareExamFormForAdd() - Prepara el formulario de exámenes para añadir uno nuevo.
      function prepareExamFormForAdd() {
        currentEditingExamId = null;
        examForm.reset();
        examDatePickerState.selectedDay = null;
        examDateInput.value = '';
        addExamFormContainer.querySelector('h3').textContent = 'Añadir Nuevo Examen';
        saveExamBtn.textContent = 'Guardar Examen';
        const priorityButtons = document.querySelectorAll('#exam-priority-group-final .priority-btn');
        const priorityOutput = document.getElementById('exam-priority-output');
        priorityButtons.forEach(btn => btn.classList.remove('active', 'low', 'medium', 'high'));
        priorityOutput.classList.add('opacity-0');
        priorityOutput.textContent = '';
      }

      // [EXAMS] :: FORM_HIDE :: hideAndResetExamForm() - Oculta y resetea el formulario de exámenes.
      function hideAndResetExamForm() {
        addExamFormContainer.classList.add('hidden');
        prepareExamFormForAdd();
      }

      // [EXAMS] :: FORM_EDIT :: openExamFormForEdit() - Rellena el formulario con los datos de un examen para editarlo.
      function openExamFormForEdit(examId) {
        const exam = userEvents.find(e => e.id === examId);
        if (!exam) { console.error("Examen no encontrado para editar"); return; }
        closeExamDetailModal();
        currentEditingExamId = examId;
        examTitleInput.value = exam.name || "";
        examDescriptionInput.value = exam.subject || ""; // Using subject for description in exams
        const examDate = parseDateString(exam.date);
        examDatePickerState.selectedDay = examDate;
        examDatePickerState.currentMonth = examDate.getMonth();
        examDatePickerState.currentYear = examDate.getFullYear();
        examDateInput.value = examDate.toLocaleDateString("es-ES");
        renderDatePickerCalendar(datePickerDaysExam, datePickerMonthDisplayExam, examDatePickerState, examDateInput);
        examTypeOralCheckbox.checked = (exam.category === "Oral");
        examTypeWrittenCheckbox.checked = (exam.category === "Escrito");
        const priorityButtons = document.querySelectorAll('#exam-priority-group-final .priority-btn');
        const priorityOutput = document.getElementById('exam-priority-output');
        priorityButtons.forEach(btn => btn.classList.remove('active', 'low', 'medium', 'high'));
        priorityOutput.classList.add('opacity-0');
        if (exam.priority) {
            const priorityBtn = document.querySelector(`#exam-priority-group-final .priority-btn[data-priority="${exam.priority}"]`);
            if (priorityBtn) {
                priorityBtn.classList.add('active', exam.priority);
                const priorityName = exam.priority === 'low' ? 'Baja' : exam.priority === 'medium' ? 'Media' : 'Alta';
                priorityOutput.textContent = priorityName;
                priorityOutput.classList.remove('opacity-0');
            }
        }
        addExamFormContainer.querySelector('h3').textContent = 'Editar Examen';
        saveExamBtn.textContent = 'Guardar Modificación';
        addExamFormContainer.classList.remove('hidden');
      }


      function initializeFormOpeningListeners() {
        const openAuthModal = () => { if (authModal) authModal.classList.remove("hidden"); };
        showAddTaskModalBtn.addEventListener('click', () => {
            if (!userId) { showCustomAlert('Inicia sesión para añadir una tarea.'); openAuthModal(); return; }
            prepareTaskFormForAdd(); 
            addTaskFormContainer.classList.remove('hidden'); 
            renderDatePickerCalendar(datePickerDays, datePickerMonthDisplay, taskDatePickerState, taskDateInput);
        });
        showAddAssignmentModalBtn.addEventListener('click', () => {
            if (!userId) { showCustomAlert('Inicia sesión para añadir un trabajo práctico.'); openAuthModal(); return; }
            prepareAssignmentFormForAdd(); // Use the new preparation function
            addAssignmentFormContainer.classList.remove('hidden');
            renderDatePickerCalendar(datePickerDaysAssignment, datePickerMonthDisplayAssignment, assignmentDatePickerState, assignmentDateInput);
        });
        showAddExamModalBtn.addEventListener('click', () => {
            if (!userId) { showCustomAlert('Inicia sesión para añadir un exámen.'); openAuthModal(); return; }
            prepareExamFormForAdd(); // Use the new preparation function
            addExamFormContainer.classList.remove('hidden');
            renderDatePickerCalendar(datePickerDaysExam, datePickerMonthDisplayExam, examDatePickerState, examDateInput);
        });
        showAddEventModalBtn.addEventListener('click', () => {
            if (!userId) { showCustomAlert('Inicia sesión para añadir un evento.'); openAuthModal(); return; }
            addEventFormContainer.classList.remove('hidden');
            eventForm.reset();
            eventDatePickerState.selectedDay = null;
            eventDateInput.value = '';
            renderDatePickerCalendar(datePickerDaysEvent, datePickerMonthDisplayEvent, eventDatePickerState, eventDateInput);
        });
      }

      function initializeFormClosingListeners() {
        const closeForm = (formContainer, form) => { formContainer.classList.add('hidden'); form.reset(); };
        cancelAddTaskBtn.addEventListener('click', hideAndResetTaskForm);
        cancelAddAssignmentBtn.addEventListener('click', hideAndResetAssignmentForm); // Use the new hide and reset function
        cancelAddExamBtn.addEventListener('click', hideAndResetExamForm); // Use the new hide and reset function
        cancelAddEventBtn.addEventListener('click', () => closeForm(addEventFormContainer, eventForm));
      }

      // [TASKS] :: DB_WRITE :: handleTaskFormSubmit() - Gestiona la lógica para crear y actualizar una tarea en Firestore.
      async function handleTaskFormSubmit(event) {
          event.preventDefault();
          if (!userId) { showCustomAlert("Debes iniciar sesión para guardar eventos."); openAuthModal(); return; }
          saveTaskBtn.disabled = true;
          
          const date = taskDatePickerState.selectedDay;
          const subject = taskSubjectSelect.value;
          const name = taskDescriptionInput.value.trim();
          let category = "";
          if (taskTypeIndividualCheckbox.checked) category = "Individual";
          else if (taskTypeGroupCheckbox.checked) category = "Grupal";
          const selectedPriorityBtn = document.querySelector('#priority-group-final .priority-btn.active');
          const priority = selectedPriorityBtn ? selectedPriorityBtn.dataset.priority : 'medium';
          
          if (!date || !name || !subject) { showCustomAlert("La materia, descripción y fecha son obligatorios."); saveTaskBtn.disabled = false; return; }
          
          const eventData = { name: name, subject: subject, category: category, priority: priority, date: date.toISOString().split("T")[0], icon: 'BookOpen', type: 'task', userId: userId, completed: currentEditingTaskId ? userEvents.find(e => e.id === currentEditingTaskId).completed : false };
          
          const isEditing = !!currentEditingTaskId;
          const taskIdToUpdate = currentEditingTaskId;
          
          hideAndResetTaskForm();
          showSuccessMessage(successMessage, isEditing ? "¡Tarea actualizada con éxito!" : "¡Tarea guardada con éxito!");
          
          try {
              if (isEditing) { await updateDoc(doc(db, "events", taskIdToUpdate), eventData); } 
              else { await addDoc(collection(db, "events"), eventData); }
          } catch (e) {
              console.error("Error guardando la tarea: ", e);
              showCustomAlert(`Error al guardar. Inténtalo de nuevo.`);
          } finally {
              saveTaskBtn.disabled = false;
          }
      }

      // [ASSIGNMENTS] :: DB_WRITE :: handleAssignmentFormSubmit() - Gestiona la lógica para crear y actualizar un trabajo práctico en Firestore.
      async function handleAssignmentFormSubmit(e) {
        e.preventDefault();
        if (!userId) { showCustomAlert("Debes iniciar sesión."); return; }
        saveAssignmentBtn.disabled = true;

        const date = assignmentDatePickerState.selectedDay;
        const subject = assignmentSubjectSelect.value;
        const name = assignmentDescriptionInput.value.trim();
        let category = "";
        if (assignmentTypeIndividualCheckbox.checked) category = "Individual";
        else if (assignmentTypeGroupCheckbox.checked) category = "Grupal";
        const selectedPriorityBtn = document.querySelector('#assignment-priority-group-final .priority-btn.active');
        const priority = selectedPriorityBtn ? selectedPriorityBtn.dataset.priority : 'medium';

        if (!date || !name || !subject) {
            showCustomAlert("La materia, descripción y fecha son obligatorios.");
            saveAssignmentBtn.disabled = false;
            return;
        }

        const eventData = {
            name: name,
            subject: subject,
            category: category,
            priority: priority,
            date: date.toISOString().split("T")[0],
            icon: 'Presentation',
            type: 'assignment',
            userId: userId,
            completed: currentEditingAssignmentId ? userEvents.find(e => e.id === currentEditingAssignmentId).completed : false
        };

        const isEditing = !!currentEditingAssignmentId;
        const assignmentIdToUpdate = currentEditingAssignmentId;

        hideAndResetAssignmentForm(); // Use the new hide and reset function
        showSuccessMessage(assignmentSuccessMessage, isEditing ? '¡Trabajo práctico actualizado!' : '¡Trabajo práctico guardado!');

        try {
            if (isEditing) {
                await updateDoc(doc(db, "events", assignmentIdToUpdate), eventData);
            } else {
                await addDoc(collection(db, "events"), eventData);
            }
        } catch (error) {
            console.error("Error guardando el trabajo práctico:", error);
            showCustomAlert("Error al guardar el trabajo práctico.");
        } finally {
            saveAssignmentBtn.disabled = false;
            currentEditingAssignmentId = null;
        }
      }

      // [EXAMS] :: DB_WRITE :: handleExamFormSubmit() - Gestiona la lógica para crear y actualizar un examen en Firestore.
      async function handleExamFormSubmit(e) {
        e.preventDefault();
        if (!userId) { showCustomAlert("Debes iniciar sesión."); return; }
        saveExamBtn.disabled = true;

        const date = examDatePickerState.selectedDay;
        const name = examTitleInput.value.trim();
        const subject = examDescriptionInput.value.trim(); // Using description as subject for exams
        let category = "";
        if (examTypeOralCheckbox.checked) category = "Oral";
        else if (examTypeWrittenCheckbox.checked) category = "Escrito";
        const selectedPriorityBtn = document.querySelector('#exam-priority-group-final .priority-btn.active');
        const priority = selectedPriorityBtn ? selectedPriorityBtn.dataset.priority : 'medium';

        if (!date || !name) { showCustomAlert("Título y fecha son obligatorios."); saveExamBtn.disabled = false; return; }
        
        const eventData = {
            name: name,
            subject: subject,
            category: category,
            priority: priority,
            date: date.toISOString().split("T")[0],
            icon: 'TestTube', type: 'exam', userId,
            completed: currentEditingExamId ? userEvents.find(e => e.id === currentEditingExamId).completed : false
        };

        const isEditing = !!currentEditingExamId;
        const examIdToUpdate = currentEditingExamId;

        hideAndResetExamForm(); // Use the new hide and reset function
        showSuccessMessage(examSuccessMessage, isEditing ? '¡Examen actualizado!' : '¡Examen guardado!');

        try {
            if (isEditing) {
                await updateDoc(doc(db, "events", examIdToUpdate), eventData);
            } else {
                await addDoc(collection(db, "events"), eventData);
            }
        } catch (error) {
            console.error("Error guardando el examen:", error);
            showCustomAlert("Error al guardar el examen.");
        } finally {
            saveExamBtn.disabled = false;
            currentEditingExamId = null;
        }
      }

      async function handleEventFormSubmit(e) {
        e.preventDefault();
        if (!userId) { showCustomAlert("Debes iniciar sesión."); return; }
        const date = eventDatePickerState.selectedDay;
        const title = eventTitleInput.value.trim();
        if (!date || !title) { showCustomAlert("Título y fecha son obligatorios."); return; }
        const eventData = {
            name: title,
            subject: eventDescriptionInput.value.trim(),
            category: eventTypePersonalCheckbox.checked ? "Personal" : (eventTypeAcademicCheckbox.checked ? "Académico" : ""),
            date: date.toISOString().split("T")[0],
            icon: 'Chat', type: 'other', userId
        };
        try {
            await addDoc(collection(db, "events"), eventData);
            showSuccessMessage(eventSuccessMessage, '¡Evento guardado!');
            addEventFormContainer.classList.add('hidden');
            eventForm.reset();
        } catch (error) {
            console.error("Error:", error);
            showCustomAlert("Error al guardar.");
        }
      }
      
      function initializeDatePickerListeners() {
        const hideAllPickers = () => [datePickerCalendar, datePickerCalendarAssignment, datePickerCalendarExam, datePickerCalendarEvent].forEach(picker => picker && picker.classList.add('hidden'));
        taskDateInput.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = datePickerCalendar.classList.contains('hidden'); hideAllPickers(); if (isHidden) datePickerCalendar.classList.remove('hidden'); });
        assignmentDateInput.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = datePickerCalendarAssignment.classList.contains('hidden'); hideAllPickers(); if (isHidden) datePickerCalendarAssignment.classList.remove('hidden'); });
        examDateInput.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = datePickerCalendarExam.classList.contains('hidden'); hideAllPickers(); if (isHidden) datePickerCalendarExam.classList.remove('hidden'); });
        eventDateInput.addEventListener('click', (e) => { e.stopPropagation(); const isHidden = datePickerCalendarEvent.classList.contains('hidden'); hideAllPickers(); if (isHidden) datePickerCalendarEvent.classList.remove('hidden'); });
        window.addEventListener('click', hideAllPickers);
      }
      
      function openAuthModal() { if (authModal) authModal.classList.remove("hidden"); }
      function closeAuthModal() { if (authModal) authModal.classList.add("hidden"); }
      
      function openTaskDetailModal(taskId) {
        const task = userEvents.find(e => e.id === taskId);
        if (!task) return;

        modalPriorityIndicator.className = "absolute left-0 top-0 bottom-0 w-1.5"; // Reset classes
        if (task.priority) {
            modalPriorityIndicator.classList.add(`priority-${task.priority}`);
        } else {
            modalPriorityIndicator.classList.add('bg-transparent');
        }

        modalTaskIcon.innerHTML = iconSVG[task.icon] || "";
        modalTaskTitle.textContent = task.subject;
        modalTaskDate.textContent = parseDateString(task.date).toLocaleDateString("es-ES", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        modalTaskDescription.textContent = task.name || 'Sin descripción.';
        if (task.category) { modalTaskCategory.textContent = task.category; modalTaskCategory.classList.remove('hidden'); } 
        else { modalTaskCategory.classList.add('hidden'); }
        editTaskBtn.dataset.taskId = taskId;
        deleteTaskBtn.dataset.taskId = taskId;
        taskDetailModal.classList.remove('hidden');
      }
      function closeTaskDetailModal() { if (taskDetailModal) taskDetailModal.classList.add('hidden'); }

      // [ASSIGNMENTS] :: MODAL :: openAssignmentDetailModal() - Abre el modal de detalles para un trabajo práctico.
      function openAssignmentDetailModal(assignmentId) {
        const assignment = userEvents.find(e => e.id === assignmentId);
        if (!assignment) return;

        modalAssignmentPriorityIndicator.className = "absolute left-0 top-0 bottom-0 w-1.5"; // Reset classes
        if (assignment.priority) {
            modalAssignmentPriorityIndicator.classList.add(`priority-${assignment.priority}`);
        } else {
            modalAssignmentPriorityIndicator.classList.add('bg-transparent');
        }

        modalAssignmentIcon.innerHTML = iconSVG[assignment.icon] || "";
        modalAssignmentTitle.textContent = assignment.subject;
        modalAssignmentDate.textContent = parseDateString(assignment.date).toLocaleDateString("es-ES", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        modalAssignmentDescription.textContent = assignment.name || 'Sin descripción.';
        if (assignment.category) { modalAssignmentCategory.textContent = assignment.category; modalAssignmentCategory.classList.remove('hidden'); } 
        else { modalAssignmentCategory.classList.add('hidden'); }
        editAssignmentBtn.dataset.assignmentId = assignmentId;
        deleteAssignmentBtn.dataset.assignmentId = assignmentId;
        assignmentDetailModal.classList.remove('hidden');
      }

      // [ASSIGNMENTS] :: MODAL :: closeAssignmentDetailModal() - Cierra el modal de detalles del trabajo práctico.
      function closeAssignmentDetailModal() { if (assignmentDetailModal) assignmentDetailModal.classList.add('hidden'); }

      // [EXAMS] :: MODAL :: openExamDetailModal() - Abre el modal de detalles para un examen.
      function openExamDetailModal(examId) {
        const exam = userEvents.find(e => e.id === examId);
        if (!exam) return;

        modalExamPriorityIndicator.className = "absolute left-0 top-0 bottom-0 w-1.5"; // Reset classes
        if (exam.priority) {
            modalExamPriorityIndicator.classList.add(`priority-${exam.priority}`);
        } else {
            modalExamPriorityIndicator.classList.add('bg-transparent');
        }

        modalExamIcon.innerHTML = iconSVG[exam.icon] || "";
        modalExamTitle.textContent = exam.name; // Title for exams is 'name'
        modalExamDate.textContent = parseDateString(exam.date).toLocaleDateString("es-ES", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        modalExamDescription.textContent = exam.subject || 'Sin descripción.'; // Description for exams is 'subject'
        if (exam.category) { modalExamCategory.textContent = exam.category; modalExamCategory.classList.remove('hidden'); } 
        else { modalExamCategory.classList.add('hidden'); }
        editExamBtnModal.dataset.examId = examId;
        deleteExamBtnModal.dataset.examId = examId;
        examDetailModal.classList.remove('hidden');
      }

      // [EXAMS] :: MODAL :: closeExamDetailModal() - Cierra el modal de detalles del examen.
      function closeExamDetailModal() { if (examDetailModal) examDetailModal.classList.add('hidden'); }


      async function handleDeleteTask(taskId) {
        showCustomConfirm("¿Estás seguro de que quieres borrar esta tarea? Esta acción no se puede deshacer.", async () => {
            try {
                await deleteDoc(doc(db, "events", taskId));
                closeTaskDetailModal();
                showSuccessMessage(successMessage, "¡Tarea borrada con éxito!");
            } catch (error) {
                console.error("Error al borrar la tarea: ", error);
                showCustomAlert("No se pudo borrar la tarea. Inténtalo de nuevo.");
            }
        });
      }

      // [ASSIGNMENTS] :: DB_DELETE :: handleDeleteAssignment() - Elimina un trabajo práctico de Firestore.
      async function handleDeleteAssignment(assignmentId) {
        showCustomConfirm("¿Estás seguro de que quieres borrar este trabajo práctico? Esta acción no se puede deshacer.", async () => {
            try {
                await deleteDoc(doc(db, "events", assignmentId));
                closeAssignmentDetailModal();
                showSuccessMessage(assignmentSuccessMessage, "¡Trabajo práctico borrado con éxito!");
            } catch (error) {
                console.error("Error al borrar el trabajo práctico: ", error);
                showCustomAlert("No se pudo borrar el trabajo práctico. Inténtalo de nuevo.");
            }
        });
      }

      // [EXAMS] :: DB_DELETE :: handleDeleteExam() - Elimina un examen de Firestore.
      async function handleDeleteExam(examId) {
        showCustomConfirm("¿Estás seguro de que quieres borrar este examen? Esta acción no se puede deshacer.", async () => {
            try {
                await deleteDoc(doc(db, "events", examId));
                closeExamDetailModal();
                showSuccessMessage(examSuccessMessage, "¡Examen borrado con éxito!");
            } catch (error) {
                console.error("Error al borrar el examen: ", error);
                showCustomAlert("No se pudo borrar el examen. Inténtalo de nuevo.");
            }
        });
      }

      // [TASKS] :: HANDLER :: setupPriorityControls() - Configura los listeners para los nuevos controles de prioridad.
      function setupPriorityControls() {
          const priorityData = [
              { name: 'Baja', value: 'low' },
              { name: 'Media', value: 'medium' },
              { name: 'Alta', value: 'high' }
          ];
          const priorityContainers = document.querySelectorAll('.priority-group');
          if (!priorityContainers) return;

          priorityContainers.forEach(container => {
              container.addEventListener('click', (e) => {
                  const selectedButton = e.target.closest('button.priority-btn');
                  if (!selectedButton) return;
                  const selectedPriority = selectedButton.dataset.priority;
                  const output = container.querySelector('.priority-output');
                  const groupContainer = selectedButton.closest('.priority-buttons-container');
                  groupContainer.querySelectorAll('button').forEach(btn => {
                      btn.classList.remove('active', 'low', 'medium', 'high');
                  });
                  selectedButton.classList.add('active', selectedPriority);
                  const priorityInfo = priorityData.find(p => p.value === selectedPriority);
                  if (priorityInfo) {
                      output.textContent = priorityInfo.name;
                      output.classList.remove('opacity-0');
                  }
              });
          });
      }

      // [TASKS] :: HANDLER :: setupSortControls() - Configura los listeners para los controles de ordenamiento.
      function setupSortControls() {
        sortCriteriaBtn = document.getElementById('sort-criteria-btn');
        sortDirectionBtn = document.getElementById('sort-direction-btn');
        sortDropdown = document.getElementById('sort-dropdown');
        sortCriteriaText = document.getElementById('sort-criteria-text');
        sortDirectionIcon = document.getElementById('sort-direction-icon');
        toggleCompletedBtn = document.getElementById('toggle-completed-btn');
        eyeOpenIcon = document.getElementById('eye-open-icon');
        eyeClosedIcon = document.getElementById('eye-closed-icon');

        assignmentSortCriteriaBtn = document.getElementById('assignment-sort-criteria-btn');
        assignmentSortDirectionBtn = document.getElementById('assignment-sort-direction-btn');
        assignmentSortDropdown = document.getElementById('assignment-sort-dropdown');
        assignmentSortCriteriaText = document.getElementById('assignment-sort-criteria-text');
        assignmentSortDirectionIcon = document.getElementById('assignment-sort-direction-icon');
        assignmentToggleCompletedBtn = document.getElementById('assignment-toggle-completed-btn');
        assignmentEyeOpenIcon = document.getElementById('assignment-eye-open-icon');
        assignmentEyeClosedIcon = document.getElementById('assignment-eye-closed-icon');
        
        examSortCriteriaBtn = document.getElementById('exam-sort-criteria-btn');
        examSortDirectionBtn = document.getElementById('exam-sort-direction-btn');
        examSortDropdown = document.getElementById('exam-sort-dropdown');
        examSortCriteriaText = document.getElementById('exam-sort-criteria-text');
        examSortDirectionIcon = document.getElementById('exam-sort-direction-icon');
        examToggleCompletedBtn = document.getElementById('exam-toggle-completed-btn');
        examEyeOpenIcon = document.getElementById('exam-eye-open-icon');
        examEyeClosedIcon = document.getElementById('exam-eye-closed-icon');


        if (sortCriteriaBtn) {
          sortCriteriaBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              sortDropdown.classList.toggle('hidden');
          });
        }

        if (sortDirectionBtn) {
          sortDirectionBtn.addEventListener('click', () => {
              taskSortDirection = taskSortDirection === 'asc' ? 'desc' : 'asc';
              sortDirectionIcon.style.transform = taskSortDirection === 'asc' ? 'rotate(0deg)' : 'rotate(180deg)';
              renderTasks();
          });
        }

        if (sortDropdown) {
          sortDropdown.addEventListener('click', (e) => {
              if (e.target.classList.contains('sort-option')) {
                  taskSortCriteria = e.target.dataset.sort;
                  sortCriteriaText.textContent = e.target.textContent;
                  sortDropdown.classList.add('hidden');
                  renderTasks();
              }
          });
        }
        
        if (toggleCompletedBtn) {
          toggleCompletedBtn.addEventListener('click', () => {
              showCompletedTasks = !showCompletedTasks;
              eyeOpenIcon.classList.toggle('hidden', !showCompletedTasks);
              eyeClosedIcon.classList.toggle('hidden', showCompletedTasks);
              if(showCompletedTasks) {
                  toggleCompletedBtn.title = 'Ocultar completadas';
              } else {
                  toggleCompletedBtn.title = 'Mostrar completadas';
              }
              renderTasks();
          });
        }

        // [ASSIGNMENTS] :: HANDLER :: setupSortControls() - Configura los listeners para los controles de ordenamiento de trabajos prácticos.
        if (assignmentSortCriteriaBtn) {
          assignmentSortCriteriaBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              assignmentSortDropdown.classList.toggle('hidden');
          });
        }

        if (assignmentSortDirectionBtn) {
          assignmentSortDirectionBtn.addEventListener('click', () => {
              assignmentSortDirection = assignmentSortDirection === 'asc' ? 'desc' : 'asc';
              assignmentSortDirectionIcon.style.transform = assignmentSortDirection === 'asc' ? 'rotate(0deg)' : 'rotate(180deg)';
              renderAssignments();
          });
        }

        if (assignmentSortDropdown) {
          assignmentSortDropdown.addEventListener('click', (e) => {
              if (e.target.classList.contains('sort-option')) {
                  assignmentSortCriteria = e.target.dataset.sort;
                  assignmentSortCriteriaText.textContent = e.target.textContent;
                  assignmentSortDropdown.classList.add('hidden');
                  renderAssignments();
              }
          });
        }
        
        if (assignmentToggleCompletedBtn) {
          assignmentToggleCompletedBtn.addEventListener('click', () => {
              showCompletedAssignments = !showCompletedAssignments;
              assignmentEyeOpenIcon.classList.toggle('hidden', !showCompletedAssignments);
              assignmentEyeClosedIcon.classList.toggle('hidden', showCompletedAssignments);
              if(showCompletedAssignments) {
                  assignmentToggleCompletedBtn.title = 'Ocultar completadas';
              } else {
                  assignmentToggleCompletedBtn.title = 'Mostrar completadas';
              }
              renderAssignments();
          });
        }

        // [EXAMS] :: HANDLER :: setupSortControls() - Configura los listeners para los controles de ordenamiento de exámenes.
        if (examSortCriteriaBtn) {
          examSortCriteriaBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              examSortDropdown.classList.toggle('hidden');
          });
        }

        if (examSortDirectionBtn) {
          examSortDirectionBtn.addEventListener('click', () => {
              examSortDirection = examSortDirection === 'asc' ? 'desc' : 'asc';
              examSortDirectionIcon.style.transform = examSortDirection === 'asc' ? 'rotate(0deg)' : 'rotate(180deg)';
              renderExams();
          });
        }

        if (examSortDropdown) {
          examSortDropdown.addEventListener('click', (e) => {
              if (e.target.classList.contains('sort-option')) {
                  examSortCriteria = e.target.dataset.sort;
                  examSortCriteriaText.textContent = e.target.textContent;
                  examSortDropdown.classList.add('hidden');
                  renderExams();
              }
          });
        }
        
        if (examToggleCompletedBtn) {
          examToggleCompletedBtn.addEventListener('click', () => {
              showCompletedExams = !showCompletedExams;
              examEyeOpenIcon.classList.toggle('hidden', !showCompletedExams);
              examEyeClosedIcon.classList.toggle('hidden', showCompletedExams);
              if(showCompletedExams) {
                  examToggleCompletedBtn.title = 'Ocultar completados';
              } else {
                  examToggleCompletedBtn.title = 'Mostrar completados';
              }
              renderExams();
          });
        }

        window.addEventListener('click', (e) => {
            if (sortDropdown && !sortDropdown.classList.contains('hidden') && !sortCriteriaBtn.contains(e.target)) {
                sortDropdown.classList.add('hidden');
            }
            if (assignmentSortDropdown && !assignmentSortDropdown.classList.contains('hidden') && !assignmentSortCriteriaBtn.contains(e.target)) {
                assignmentSortDropdown.classList.add('hidden');
            }
            if (examSortDropdown && !examSortDropdown.classList.contains('hidden') && !examSortCriteriaBtn.contains(e.target)) {
                examSortDropdown.classList.add('hidden');
            }
        });
      }
      
      // [AVATAR] :: DB_READ :: loadAvatars() - Carga los avatares desde Firestore y prepara el modal.
      async function loadAvatars() {
          const container = document.getElementById("avatar-options-list");
          if (!container) return;
          container.innerHTML = ""; // Limpiar antes de cargar
          try {
              const querySnapshot = await getDocs(collection(db, "avatares"));
              querySnapshot.forEach((docSnap) => {
                  const base64 = docSnap.data().data;
                  const name = docSnap.id;
                  const imgContainer = document.createElement("div");
                  imgContainer.className = "avatar-option cursor-pointer p-1 rounded-full hover:bg-indigo-100";
                  const img = document.createElement("img");
                  img.src = `data:image/png;base64,${base64}`;
                  img.alt = name;
                  img.className = "size-16 rounded-full transition-transform duration-200";

                  // [AVATAR] :: DB_WRITE :: Evento para guardar el avatar seleccionado en Firestore.
                  img.addEventListener("click", async () => {
                      if (!auth.currentUser) {
                          showCustomAlert("Debes iniciar sesión para cambiar tu avatar.");
                          return;
                      }
                      try {
                          await setDoc(doc(db, "usuarios", auth.currentUser.uid), {
                              avatar: img.src
                          }, { merge: true });
                          
                          // Actualizar UI inmediatamente
                          currentAvatarImg.src = img.src;
                          const avatarImgHtml = `<img src="${img.src}" alt="Foto de perfil" class="size-full rounded-full object-cover">`;
                          userIconContainer.innerHTML = avatarImgHtml;
                          userIconContainerMobile.innerHTML = avatarImgHtml;

                          showAlertMessage("¡Avatar actualizado!");
                          avatarModal.classList.add('hidden');
                      } catch (error) {
                          console.error("Error guardando avatar en Firestore:", error);
                          showCustomAlert("No se pudo actualizar el avatar.");
                      }
                  });
                  imgContainer.appendChild(img);
                  container.appendChild(imgContainer);
              });

              // [AVATAR] :: UI :: Añadir botón para restaurar el avatar por defecto.
              const restoreBtnContainer = document.createElement('div');
              restoreBtnContainer.className = "col-span-4 mt-2 pt-2 border-t border-gray-200";
              const restoreBtn = document.createElement("button");
              restoreBtn.textContent = "Restaurar avatar original";
              restoreBtn.className = "w-full text-sm text-blue-600 hover:underline";
              restoreBtn.addEventListener("click", async () => {
                  if (!auth.currentUser) return;
                  const defaultPhoto = auth.currentUser.photoURL || "https://placehold.co/64x64/E2E8F0/475569?text=SM";
                  try {
                      await updateDoc(doc(db, "usuarios", auth.currentUser.uid), {
                          avatar: null
                      });

                      currentAvatarImg.src = defaultPhoto;
                      const avatarImgHtml = `<img src="${defaultPhoto}" alt="Foto de perfil" class="size-full rounded-full object-cover">`;
                      userIconContainer.innerHTML = avatarImgHtml;
                      userIconContainerMobile.innerHTML = avatarImgHtml;

                      showAlertMessage("¡Avatar restaurado!");
                      avatarModal.classList.add("hidden");
                  } catch (e) {
                      console.error("Error restaurando avatar:", e);
                      showCustomAlert("No se pudo restaurar el avatar.");
                  }
              });
              restoreBtnContainer.appendChild(restoreBtn);
              container.appendChild(restoreBtnContainer);

          } catch (error) {
              console.error("Error al cargar avatares:", error);
          }
      }

      function setupCheckboxGroup(checkboxes) {
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    checkboxes.forEach(otherCheckbox => {
                        if (otherCheckbox !== checkbox) {
                            otherCheckbox.checked = false;
                        }
                    });
                }
            });
        });
      }

      // --- Funciones para Materias ---
      function renderSubjects() {
          if (!subjectsListContainer) return;
          subjectsListContainer.innerHTML = '';
          if (userSubjects.length === 0) {
              subjectsListContainer.innerHTML = `<p class="text-sm text-slate-500 italic">No tienes materias guardadas.</p>`;
          } else {
              userSubjects.forEach(subject => {
                  const subjectEl = document.createElement('div');
                  subjectEl.className = 'flex items-center justify-between bg-slate-100 p-2 rounded-md';
                  subjectEl.innerHTML = `
                      <span class="text-slate-800">${subject.name}</span>
                      <div class="flex gap-2">
                          <button data-id="${subject.id}" class="edit-subject-btn text-slate-500 hover:text-blue-600">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,164v40a16,16,0,0,0,16,16H92a15.86,15.86,0,0,0,12-4.69L227.31,96a16,16,0,0,0,0-22.63ZM88,192H56V168l88-88,32,32Z"></path></svg>
                          </button>
                          <button data-id="${subject.id}" class="delete-subject-btn text-slate-500 hover:text-red-600">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96ZM192,208H64V64H192Z"></path></svg>
                          </button>
                      </div>
                  `;
                  subjectsListContainer.appendChild(subjectEl);
              });
          }
      }

      function populateSubjectsDropdown() {
        // Include assignmentSubjectSelect here
        const dropdowns = [taskSubjectSelect, assignmentSubjectSelect];
        dropdowns.forEach(dropdown => {
            if (!dropdown) return;
            const currentValue = dropdown.value;
            dropdown.innerHTML = '<option value="">Selecciona una materia...</option>';
            userSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.name;
                option.textContent = subject.name;
                dropdown.appendChild(option);
            });
            dropdown.value = currentValue;
        });
      }

      async function addSubject() {
          const name = subjectNameInput.value.trim();
          if (name && userId) {
              try {
                  await addDoc(collection(db, 'subjects'), { name, userId });
                  subjectNameInput.value = '';
                  showAlertMessage('Materia añadida con éxito.');
              } catch (error) {
                  console.error("Error al añadir materia: ", error);
                  showCustomAlert('No se pudo añadir la materia.');
              }
          }
      }

      async function deleteSubject(id) {
          showCustomConfirm('¿Seguro que quieres eliminar esta materia?', async () => {
              try {
                  await deleteDoc(doc(db, 'subjects', id));
                  showAlertMessage('Materia eliminada.');
              } catch (error) {
                  console.error("Error al eliminar materia: ", error);
                  showCustomAlert('No se pudo eliminar la materia.');
              }
          });
      }

      async function editSubject(id, oldName) {
          const newName = prompt('Edita el nombre de la materia:', oldName);
          if (newName && newName.trim() !== '' && newName !== oldName) {
              try {
                  await updateDoc(doc(db, 'subjects', id), { name: newName.trim() });
                  showAlertMessage('Materia actualizada.');
              } catch (error) {
                  console.error("Error al actualizar materia: ", error);
                  showCustomAlert('No se pudo actualizar la materia.');
              }
          }
      }


      document.addEventListener("DOMContentLoaded", async () => {
        // Assign all DOM elements
        monthDisplay = document.getElementById("monthDisplay");
        calendarDaysMonth = document.getElementById("calendarDaysMonth");
        prevMonthBtn = document.getElementById("prevMonthBtn");
        nextMonthBtn = document.getElementById("nextMonthBtn");
        weekDisplay = document.getElementById("weekDisplay");
        calendarDaysWeek = document.getElementById("calendarDaysWeek");
        prevWeekBtn = document.getElementById("prevWeekBtn");
        nextWeekBtn = document.getElementById("nextWeekBtn");
        dayDisplay = document.getElementById("dayDisplay");
        currentDayNameDisplay = document.getElementById("currentDayNameDisplay");
        calendarDaysDay = document.getElementById("calendarDaysDay");
        prevDayBtn = document.getElementById("prevDayBtn");
        nextDayBtn = document.getElementById("nextDayBtn");
        navLinks = document.querySelectorAll("header nav a, #mobile-menu nav a");
        sections = document.querySelectorAll(".layout-content-container");
        calendarViewButtons = document.querySelectorAll("[data-calendar-view]");
        upcomingEventsContainer = document.getElementById("upcomingEvents");
        selectedDayEventsContainer = document.getElementById("selectedDayEventsContainer");
        selectedDayTitle = document.getElementById("selectedDayTitle");
        monthEventsTitle = document.getElementById("monthEventsTitle");
        monthEventsContainer = document.getElementById("monthEventsContainer");
        weekEventsTitle = document.getElementById("weekEventsTitle");
        weekEventsContainer = document.getElementById("weekEventsContainer");
        
        // Task form elements
        addTaskFormContainer = document.getElementById("addTaskFormContainer");
        showAddTaskModalBtn = document.getElementById("showAddTaskModalBtn");
        cancelAddTaskBtn = document.getElementById("cancelAddTask");
        saveTaskBtn = document.getElementById("saveTask");
        taskForm = document.getElementById("taskForm");
        taskDateInput = document.getElementById("taskDate");
        taskSubjectSelect = document.getElementById("taskSubjectSelect");
        taskDescriptionInput = document.getElementById("taskDescription");
        taskTypeIndividualCheckbox = document.getElementById("taskTypeIndividual");
        taskTypeGroupCheckbox = document.getElementById("taskTypeGroup");
        datePickerCalendar = document.getElementById("datePickerCalendar");
        datePickerMonthDisplay = document.getElementById("datePickerMonthDisplay");
        datePickerDays = document.getElementById("datePickerDays");
        prevDatePickerMonthBtn = document.getElementById("prevDatePickerMonth");
        nextDatePickerMonthBtn = document.getElementById("nextDatePickerMonth");
        tasksListContainer = document.getElementById("tasksListContainer");
        successMessage = document.getElementById("successMessage");
        
        // Assignment form elements
        addAssignmentFormContainer = document.getElementById("addAssignmentFormContainer");
        showAddAssignmentModalBtn = document.getElementById("showAddAssignmentModalBtn");
        cancelAddAssignmentBtn = document.getElementById("cancelAddAssignment");
        saveAssignmentBtn = document.getElementById("saveAssignment");
        assignmentForm = document.getElementById("assignmentForm");
        assignmentDateInput = document.getElementById("assignmentDate");
        assignmentSubjectSelect = document.getElementById("assignmentSubjectSelect");
        assignmentDescriptionInput = document.getElementById("assignmentDescription");
        assignmentTypeIndividualCheckbox = document.getElementById("assignmentTypeIndividual");
        assignmentTypeGroupCheckbox = document.getElementById("assignmentTypeGroup");
        datePickerCalendarAssignment = document.getElementById("datePickerCalendarAssignment");
        datePickerMonthDisplayAssignment = document.getElementById("datePickerMonthDisplayAssignment");
        datePickerDaysAssignment = document.getElementById("datePickerDaysAssignment");
        prevDatePickerMonthAssignmentBtn = document.getElementById("prevDatePickerMonthAssignment");
        nextDatePickerMonthAssignmentBtn = document.getElementById("nextDatePickerMonthAssignment");
        assignmentsListContainer = document.getElementById("assignmentsListContainer");
        assignmentSuccessMessage = document.getElementById("assignmentSuccessMessage");

        // Exam form elements
        addExamFormContainer = document.getElementById("addExamFormContainer");
        showAddExamModalBtn = document.getElementById("showAddExamModalBtn");
        cancelAddExamBtn = document.getElementById("cancelAddExam");
        saveExamBtn = document.getElementById("saveExam");
        examForm = document.getElementById("examForm");
        examDateInput = document.getElementById("examDate");
        examTitleInput = document.getElementById("examTitle");
        examDescriptionInput = document.getElementById("examDescription");
        examTypeOralCheckbox = document.getElementById("examTypeOral");
        examTypeWrittenCheckbox = document.getElementById("examTypeWritten");
        datePickerCalendarExam = document.getElementById("datePickerCalendarExam");
        datePickerMonthDisplayExam = document.getElementById("datePickerMonthDisplayExam");
        datePickerDaysExam = document.getElementById("datePickerDaysExam");
        prevDatePickerMonthExamBtn = document.getElementById("prevDatePickerMonthExam");
        nextDatePickerMonthExamBtn = document.getElementById("nextDatePickerMonthExam");
        examsListContainer = document.getElementById("examsListContainer");
        examSuccessMessage = document.getElementById("examSuccessMessage");

        // Event form elements
        addEventFormContainer = document.getElementById("addEventFormContainer");
        showAddEventModalBtn = document.getElementById("showAddEventModalBtn");
        cancelAddEventBtn = document.getElementById("cancelAddEvent");
        saveEventBtn = document.getElementById("saveEvent");
        eventForm = document.getElementById("eventForm");
        eventDateInput = document.getElementById("eventDate");
        eventTitleInput = document.getElementById("eventTitle");
        eventDescriptionInput = document.getElementById("eventDescription");
        eventTypePersonalCheckbox = document.getElementById("eventTypePersonal");
        eventTypeAcademicCheckbox = document.getElementById("eventTypeAcademic");
        datePickerCalendarEvent = document.getElementById("datePickerCalendarEvent");
        datePickerMonthDisplayEvent = document.getElementById("datePickerMonthDisplayEvent");
        datePickerDaysEvent = document.getElementById("datePickerDaysEvent");
        prevDatePickerMonthEventBtn = document.getElementById("prevDatePickerMonthEvent");
        nextDatePickerMonthEventBtn = document.getElementById("nextDatePickerMonthEvent");
        eventsListContainer = document.getElementById("eventsListContainer");
        eventSuccessMessage = document.getElementById("eventSuccessMessage");
        
        // Auth and Modals
        authModal = document.getElementById("authModal");
        closeAuthModalBtn = document.getElementById("closeAuthModalBtn");
        userIconContainer = document.getElementById("userIconContainer");
        userIconContainerMobile = document.getElementById("userIconContainerMobile");
        authContent = document.getElementById('authContent');
        welcomeMessage = document.getElementById('welcomeMessage');
        authMessage = document.getElementById('authMessage');
        authTitle = document.getElementById('authTitle');
        hamburgerBtn = document.getElementById("hamburgerBtn");
        mobileMenu = document.getElementById("mobile-menu");
        closeMobileMenuBtn = document.getElementById("closeMobileMenuBtn");
        bellBtn = document.getElementById("bellBtn");
        taskDetailModal = document.getElementById('taskDetailModal');
        closeTaskDetailModalBtn = document.getElementById('closeTaskDetailModalBtn');
        modalTaskIcon = document.getElementById('modalTaskIcon');
        modalTaskTitle = document.getElementById('modalTaskTitle');
        modalTaskDate = document.getElementById('modalTaskDate');
        modalTaskDescription = document.getElementById('modalTaskDescription');
        modalTaskCategory = document.getElementById('modalTaskCategory');
        editTaskBtn = document.getElementById('editTaskBtn');
        deleteTaskBtn = document.getElementById('deleteTaskBtn');
        modalPriorityIndicator = document.getElementById('modalPriorityIndicator');

        // New Assignment Detail Modal elements
        assignmentDetailModal = document.getElementById('assignmentDetailModal');
        closeAssignmentDetailModalBtn = document.getElementById('closeAssignmentDetailModalBtn');
        modalAssignmentIcon = document.getElementById('modalAssignmentIcon');
        modalAssignmentTitle = document.getElementById('modalAssignmentTitle');
        modalAssignmentDate = document.getElementById('modalAssignmentDate');
        modalAssignmentDescription = document.getElementById('modalAssignmentDescription');
        editAssignmentBtn = document.getElementById('editAssignmentBtn');
        deleteAssignmentBtn = document.getElementById('deleteAssignmentBtn');
        modalAssignmentCategory = document.getElementById('modalAssignmentCategory');
        modalAssignmentPriorityIndicator = document.getElementById('modalAssignmentPriorityIndicator');
        
        // New Exam Detail Modal elements
        examDetailModal = document.getElementById('examDetailModal');
        closeExamDetailModalBtn = document.getElementById('closeExamDetailModalBtn');
        modalExamIcon = document.getElementById('modalExamIcon');
        modalExamTitle = document.getElementById('modalExamTitle');
        modalExamDate = document.getElementById('modalExamDate');
        modalExamDescription = document.getElementById('modalExamDescription');
        editExamBtnModal = document.getElementById('editExamBtnModal');
        deleteExamBtnModal = document.getElementById('deleteExamBtnModal');
        modalExamCategory = document.getElementById('modalExamCategory');
        modalExamPriorityIndicator = document.getElementById('modalExamPriorityIndicator');

        // Sorting elements
        sortCriteriaBtn = document.getElementById('sort-criteria-btn');
        sortDirectionBtn = document.getElementById('sort-direction-btn');
        sortDropdown = document.getElementById('sort-dropdown');
        sortCriteriaText = document.getElementById('sort-criteria-text');
        sortDirectionIcon = document.getElementById('sort-direction-icon');
        toggleCompletedBtn = document.getElementById('toggle-completed-btn');
        eyeOpenIcon = document.getElementById('eye-open-icon');
        eyeClosedIcon = document.getElementById('eye-closed-icon');

        assignmentSortCriteriaBtn = document.getElementById('assignment-sort-criteria-btn');
        assignmentSortDirectionBtn = document.getElementById('assignment-sort-direction-btn');
        assignmentSortDropdown = document.getElementById('assignment-sort-dropdown');
        assignmentSortCriteriaText = document.getElementById('assignment-sort-criteria-text');
        assignmentSortDirectionIcon = document.getElementById('assignment-sort-direction-icon');
        assignmentToggleCompletedBtn = document.getElementById('assignment-toggle-completed-btn');
        assignmentEyeOpenIcon = document.getElementById('assignment-eye-open-icon');
        assignmentEyeClosedIcon = document.getElementById('assignment-eye-closed-icon');

        examSortCriteriaBtn = document.getElementById('exam-sort-criteria-btn');
        examSortDirectionBtn = document.getElementById('exam-sort-direction-btn');
        examSortDropdown = document.getElementById('exam-sort-dropdown');
        examSortCriteriaText = document.getElementById('exam-sort-criteria-text');
        examSortDirectionIcon = document.getElementById('exam-sort-direction-icon');
        examToggleCompletedBtn = document.getElementById('exam-toggle-completed-btn');
        examEyeOpenIcon = document.getElementById('exam-eye-open-icon');
        examEyeClosedIcon = document.getElementById('exam-eye-closed-icon');
        
        // Settings and Avatar
        settingsSection = document.getElementById('settings-section');
        changeAvatarBtn = document.getElementById('change-avatar-btn');
        avatarModal = document.getElementById('avatar-modal');
        closeAvatarModalBtn = document.getElementById('close-avatar-modal-btn');
        avatarOptionsList = document.getElementById('avatar-options-list');
        currentAvatarImg = document.getElementById('current-avatar-img');

        // Subjects elements
        subjectsListContainer = document.getElementById('subjectsListContainer');
        subjectNameInput = document.getElementById('subjectNameInput');
        addSubjectBtn = document.getElementById('addSubjectBtn');

        // Initialize Firebase
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            updateUIForAuthState(user);
        });

        // Setup all event listeners
        initializeFormOpeningListeners();
        initializeFormClosingListeners(); 
        initializeDatePickerListeners();
        setupPriorityControls();
        setupSortControls();
        
        // Form submission listeners
        taskForm.addEventListener('submit', handleTaskFormSubmit);
        assignmentForm.addEventListener('submit', handleAssignmentFormSubmit);
        examForm.addEventListener('submit', handleExamFormSubmit);
        eventForm.addEventListener('submit', handleEventFormSubmit);

        // Checkbox groups
        setupCheckboxGroup([taskTypeIndividualCheckbox, taskTypeGroupCheckbox]);
        setupCheckboxGroup([assignmentTypeIndividualCheckbox, assignmentTypeGroupCheckbox]);
        setupCheckboxGroup([examTypeOralCheckbox, examTypeWrittenCheckbox]);
        setupCheckboxGroup([eventTypePersonalCheckbox, eventTypeAcademicCheckbox]);

        // Calendar navigation
        if (prevMonthBtn) prevMonthBtn.addEventListener("click", () => { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } const daysInNewMonth = new Date(currentYear, currentMonth + 1, 0).getDate(); selectedDay = new Date(currentYear, currentMonth, Math.min(selectedDay.getDate(), daysInNewMonth)); renderMonthCalendar(); showActiveCalendarViewEvents(); });
        if (nextMonthBtn) nextMonthBtn.addEventListener("click", () => { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } const daysInNewMonth = new Date(currentYear, currentMonth + 1, 0).getDate(); selectedDay = new Date(currentYear, currentMonth, Math.min(selectedDay.getDate(), daysInNewMonth)); renderMonthCalendar(); showActiveCalendarViewEvents(); });
        if (prevWeekBtn) prevWeekBtn.addEventListener("click", () => { currentWeekStartDate.setDate(currentWeekStartDate.getDate() - 7); selectedDay = new Date(currentWeekStartDate); renderWeekCalendar(); showActiveCalendarViewEvents(); });
        if (nextWeekBtn) nextWeekBtn.addEventListener("click", () => { currentWeekStartDate.setDate(currentWeekStartDate.getDate() + 7); selectedDay = new Date(currentWeekStartDate); renderWeekCalendar(); showActiveCalendarViewEvents(); });
        if (prevDayBtn) prevDayBtn.addEventListener("click", () => { selectedDay.setDate(selectedDay.getDate() - 1); renderDayCalendar(); renderMonthCalendar(); renderWeekCalendar(); showActiveCalendarViewEvents(); });
        if (nextDayBtn) nextDayBtn.addEventListener("click", () => { selectedDay.setDate(selectedDay.getDate() + 1); renderDayCalendar(); renderMonthCalendar(); renderWeekCalendar(); showActiveCalendarViewEvents(); });
        
        // Date Picker Navigation Listeners
        prevDatePickerMonthBtn.addEventListener('click', () => {
            taskDatePickerState.currentMonth--;
            if (taskDatePickerState.currentMonth < 0) {
                taskDatePickerState.currentMonth = 11;
                taskDatePickerState.currentYear--;
            }
            renderDatePickerCalendar(datePickerDays, datePickerMonthDisplay, taskDatePickerState, taskDateInput);
        });
        nextDatePickerMonthBtn.addEventListener('click', () => {
            taskDatePickerState.currentMonth++;
            if (taskDatePickerState.currentMonth > 11) {
                taskDatePickerState.currentMonth = 0;
                taskDatePickerState.currentYear++;
            }
            renderDatePickerCalendar(datePickerDays, datePickerMonthDisplay, taskDatePickerState, taskDateInput);
        });

        prevDatePickerMonthAssignmentBtn.addEventListener('click', () => {
            assignmentDatePickerState.currentMonth--;
            if (assignmentDatePickerState.currentMonth < 0) {
                assignmentDatePickerState.currentMonth = 11;
                assignmentDatePickerState.currentYear--;
            }
            renderDatePickerCalendar(datePickerDaysAssignment, datePickerMonthDisplayAssignment, assignmentDatePickerState, assignmentDateInput);
        });
        nextDatePickerMonthAssignmentBtn.addEventListener('click', () => {
            assignmentDatePickerState.currentMonth++;
            if (assignmentDatePickerState.currentMonth > 11) {
                assignmentDatePickerState.currentMonth = 0;
                assignmentDatePickerState.currentYear++;
            }
            renderDatePickerCalendar(datePickerDaysAssignment, datePickerMonthDisplayAssignment, assignmentDatePickerState, assignmentDateInput);
        });

        prevDatePickerMonthExamBtn.addEventListener('click', () => {
            examDatePickerState.currentMonth--;
            if (examDatePickerState.currentMonth < 0) {
                examDatePickerState.currentMonth = 11;
                examDatePickerState.currentYear--;
            }
            renderDatePickerCalendar(datePickerDaysExam, datePickerMonthDisplayExam, examDatePickerState, examDateInput);
        });
        nextDatePickerMonthExamBtn.addEventListener('click', () => {
            examDatePickerState.currentMonth++;
            if (examDatePickerState.currentMonth > 11) {
                examDatePickerState.currentMonth = 0;
                examDatePickerState.currentYear++;
            }
            renderDatePickerCalendar(datePickerDaysExam, datePickerMonthDisplayExam, examDatePickerState, examDateInput);
        });

        prevDatePickerMonthEventBtn.addEventListener('click', () => {
            eventDatePickerState.currentMonth--;
            if (eventDatePickerState.currentMonth < 0) {
                eventDatePickerState.currentMonth = 11;
                eventDatePickerState.currentYear--;
            }
            renderDatePickerCalendar(datePickerDaysEvent, datePickerMonthDisplayEvent, eventDatePickerState, eventDateInput);
        });
        nextDatePickerMonthEventBtn.addEventListener('click', () => {
            eventDatePickerState.currentMonth++;
            if (eventDatePickerState.currentMonth > 11) {
                eventDatePickerState.currentMonth = 0;
                eventDatePickerState.currentYear++;
            }
            renderDatePickerCalendar(datePickerDaysEvent, datePickerMonthDisplayEvent, eventDatePickerState, eventDateInput);
        });

        // Section navigation
        navLinks.forEach((link) => { link.addEventListener("click", (event) => { event.preventDefault(); const sectionId = event.target.dataset.section + "-section"; showSection(sectionId); if (mobileMenu) mobileMenu.classList.add("hidden"); }); });
        
        // Calendar view toggles
        calendarViewButtons.forEach((button) => { button.addEventListener("click", (event) => { const view = event.currentTarget.dataset.calendarView; [document.getElementById("month-view"), document.getElementById("week-view"), document.getElementById("day-view")].forEach((el) => el.classList.add("hidden")); if (view === "month") { document.getElementById("month-view").classList.remove("hidden"); currentMonth = selectedDay.getMonth(); currentYear = selectedDay.getFullYear(); renderMonthCalendar(); } else if (view === "week") { document.getElementById("week-view").classList.remove("hidden"); currentWeekStartDate = getMonday(selectedDay); renderWeekCalendar(); } else if (view === "day") { document.getElementById("day-view").classList.remove("hidden"); renderDayCalendar(); } showActiveCalendarViewEvents(); calendarViewButtons.forEach((btn) => { btn.classList.remove("bg-[#6A8EEB]", "text-white"); btn.classList.add("bg-[#e7edf3]", "text-[#334155]"); }); event.currentTarget.classList.remove("bg-[#e7edf3]", "text-[#334155]"); event.currentTarget.classList.add("bg-[#6A8EEB]", "text-white"); }); });
        
        // Mobile menu
        if (hamburgerBtn) hamburgerBtn.addEventListener("click", () => { if (mobileMenu) mobileMenu.classList.remove("hidden"); });
        if (closeMobileMenuBtn) closeMobileMenuBtn.addEventListener("click", () => { if (mobileMenu) mobileMenu.classList.add("hidden"); });
        
        // Other UI listeners
        if (bellBtn) bellBtn.addEventListener("click", () => { if (!userId) { showCustomAlert('Logueate para ver tus notificaciones'); openAuthModal(); } else { showAlertMessage("No hay notificaciones pendientes."); } });
        userIconContainer.addEventListener("click", openAuthModal);
        userIconContainerMobile.addEventListener("click", openAuthModal);
        closeAuthModalBtn.addEventListener("click", closeAuthModal);
        authModal.addEventListener("click", (event) => { if (event.target === authModal) { closeAuthModal(); } });
        closeTaskDetailModalBtn.addEventListener('click', closeTaskDetailModal);
        closeAssignmentDetailModalBtn.addEventListener('click', closeAssignmentDetailModal); // Close assignment detail modal
        closeExamDetailModalBtn.addEventListener('click', closeExamDetailModal); // Close exam detail modal
        
        // Task list interactions
        tasksListContainer.addEventListener('click', (e) => { 
            if (e.target.matches('.completion-checkbox')) {
                const taskId = e.target.dataset.taskId;
                const isChecked = e.target.checked;
                const taskDocRef = doc(db, "events", taskId);
                updateDoc(taskDocRef, { completed: isChecked });
                if (isChecked && typeof confetti === 'function') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
                return;
            }
            const taskCard = e.target.closest('[data-task-id]'); 
            if (taskCard) { 
                openTaskDetailModal(taskCard.dataset.taskId); 
            } 
        });
        deleteTaskBtn.addEventListener('click', (e) => { const taskId = e.currentTarget.dataset.taskId; if(taskId) handleDeleteTask(taskId); });
        editTaskBtn.addEventListener('click', (e) => { const taskId = e.currentTarget.dataset.taskId; if(taskId) openTaskFormForEdit(taskId); });

        // [ASSIGNMENTS] :: LIST_INTERACTIONS :: Event listeners for assignment cards.
        assignmentsListContainer.addEventListener('click', (e) => { 
            if (e.target.matches('.completion-checkbox')) {
                const assignmentId = e.target.dataset.assignmentId;
                const isChecked = e.target.checked;
                const assignmentDocRef = doc(db, "events", assignmentId);
                updateDoc(assignmentDocRef, { completed: isChecked });
                if (isChecked && typeof confetti === 'function') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
                return;
            }
            const assignmentCard = e.target.closest('[data-assignment-id]'); 
            if (assignmentCard) { 
                openAssignmentDetailModal(assignmentCard.dataset.assignmentId); 
            } 
        });
        if (deleteAssignmentBtn) {
          deleteAssignmentBtn.addEventListener('click', (e) => { 
            const assignmentId = e.currentTarget.dataset.assignmentId; 
            if(assignmentId) handleDeleteAssignment(assignmentId); 
          });
        }
        if (editAssignmentBtn) {
          editAssignmentBtn.addEventListener('click', (e) => { 
            const assignmentId = e.currentTarget.dataset.assignmentId; 
            if(assignmentId) openAssignmentFormForEdit(assignmentId); 
          });
        }

        // [EXAMS] :: LIST_INTERACTIONS :: Event listeners for exam cards.
        examsListContainer.addEventListener('click', (e) => { 
            if (e.target.matches('.completion-checkbox')) {
                const examId = e.target.dataset.examId;
                const isChecked = e.target.checked;
                const examDocRef = doc(db, "events", examId);
                updateDoc(examDocRef, { completed: isChecked });
                if (isChecked && typeof confetti === 'function') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
                return;
            }
            const examCard = e.target.closest('[data-exam-id]'); 
            if (examCard) { 
                openExamDetailModal(examCard.dataset.examId); 
            } 
        });
        if (deleteExamBtnModal) {
          deleteExamBtnModal.addEventListener('click', (e) => { 
            const examId = e.currentTarget.dataset.examId; 
            if(examId) handleDeleteExam(examId); 
          });
        }
        if (editExamBtnModal) {
          editExamBtnModal.addEventListener('click', (e) => { 
            const examId = e.currentTarget.dataset.examId; 
            if(examId) openExamFormForEdit(examId); 
          });
        }

        // Avatar modal listeners
        changeAvatarBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            avatarModal.classList.toggle('hidden');
        });
        closeAvatarModalBtn.addEventListener('click', () => avatarModal.classList.add('hidden'));
        window.addEventListener('click', (e) => {
            if (!avatarModal.classList.contains('hidden') && !avatarModal.contains(e.target) && e.target !== changeAvatarBtn) {
                avatarModal.classList.add('hidden');
            }
        });

        // Subjects listeners
        addSubjectBtn.addEventListener('click', addSubject);
        subjectsListContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-subject-btn');
            if (deleteBtn) {
                deleteSubject(deleteBtn.dataset.id);
            }
            const editBtn = e.target.closest('.edit-subject-btn');
            if (editBtn) {
                const subjectSpan = editBtn.parentElement.previousElementSibling;
                editSubject(editBtn.dataset.id, subjectSpan.textContent);
            }
        });

        // Initial render
        showSection("calendar-section");
        renderAllViews();
      });
    </script>
  </body>
</html>